<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hormur - Support Client IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .line-clamp-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide-in-right {
            animation: slideInRight 0.3s ease-out;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        
        .pulse-urgent {
            animation: pulseUrgent 2s infinite;
        }
        
        @keyframes pulseUrgent {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
        }
        
        .auto-send-indicator {
            background: linear-gradient(45deg, #10b981, #059669);
            animation: pulse 2s infinite;
        }
        
        .urgent-indicator {
            background: linear-gradient(45deg, #ef4444, #dc2626);
            animation: bounce 1s infinite;
        }
        
        .hormur-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .tab-active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .tab-inactive {
            background: #f3f4f6;
            color: #6b7280;
        }
        
        .message-card {
            transition: all 0.2s ease;
            transform: translateZ(0);
        }
        
        .message-card:active {
            transform: scale(0.98);
        }
        
        .bottom-nav {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }
        
        .modal-overlay {
            backdrop-filter: blur(6px);
            background: rgba(0, 0, 0, 0.5);
        }
        
        .priority-high {
            border-left: 4px solid #ef4444;
            background: linear-gradient(90deg, #fef2f2 0%, #ffffff 30%);
        }
        
        .priority-medium {
            border-left: 4px solid #f59e0b;
            background: linear-gradient(90deg, #fef3c7 0%, #ffffff 30%);
        }
        
        .priority-low {
            border-left: 4px solid #10b981;
        }
        
        .auto-send-badge {
            background: linear-gradient(45deg, #10b981, #059669);
            color: white;
            animation: pulse 2s infinite;
        }
        
        .archived-badge {
            background: linear-gradient(45deg, #6b7280, #4b5563);
            color: white;
        }
        
        .custom-scrollbar {
            scrollbar-width: thin;
            scrollbar-color: #d1d5db #f3f4f6;
        }
        
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f3f4f6;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 2px;
        }
        
        @media (max-width: 768px) {
            .mobile-only { display: block; }
            .desktop-only { display: none; }
        }
        
        @media (min-width: 769px) {
            .mobile-only { display: none; }
            .desktop-only { display: block; }
        }

        .archive-transition {
            transition: all 0.3s ease;
        }

        .archive-transition.archived {
            opacity: 0.6;
            transform: scale(0.95);
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
    <!-- Login Overlay -->
    <div id="login-overlay" class="fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4">
        <div class="hormur-gradient p-6 sm:p-8 rounded-2xl shadow-2xl max-w-md w-full text-white">
            <div class="text-center mb-6">
                <div class="w-16 h-16 mx-auto mb-4 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                    <i data-lucide="bot" class="w-8 h-8 text-white"></i>
                </div>
                <h2 class="text-2xl font-bold">Hormur IA Assistant</h2>
                <p class="text-indigo-100 mt-2 text-sm">Support Client Automatis√©</p>
            </div>
            
            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-indigo-100 mb-2">Email professionnel</label>
                    <input 
                        type="email" 
                        id="login-email"
                        required
                        class="w-full px-4 py-3 bg-white bg-opacity-20 border border-white border-opacity-30 rounded-lg text-white placeholder-indigo-200"
                        placeholder="votre.email@hormur.com"
                    />
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-indigo-100 mb-2">Mot de passe</label>
                    <input 
                        type="password" 
                        id="login-password"
                        required
                        class="w-full px-4 py-3 bg-white bg-opacity-20 border border-white border-opacity-30 rounded-lg text-white placeholder-indigo-200"
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                    />
                </div>
                
                <div id="login-error" class="hidden bg-red-500 bg-opacity-20 border border-red-300 text-red-100 px-4 py-3 rounded-lg text-sm">
                    Email ou mot de passe incorrect
                </div>
                
                <button 
                    type="submit"
                    class="w-full bg-white text-indigo-600 py-3 px-4 rounded-lg hover:bg-indigo-50 transition-colors font-semibold"
                >
                    Se connecter
                </button>
            </form>
            
            <div class="mt-6 text-center text-xs text-indigo-200">
                <p class="mb-2">√âquipe Hormur :</p>
                <div class="space-y-1">
                    <p>üé® El√©onore - Relations Artistes</p>
                    <p>üè° Martin - Partenariats Lieux</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="main-app" class="hidden">
        <!-- Mobile Header -->
        <header class="bg-white shadow-sm border-b sticky top-0 z-40">
            <div class="px-4 py-3">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <i data-lucide="bot" class="w-6 h-6 text-indigo-600"></i>
                        <div>
                            <h1 class="text-lg font-bold text-gray-900">Hormur IA</h1>
                            <div class="flex items-center space-x-2">
                                <div id="ai-status" class="flex items-center space-x-1">
                                    <div class="w-2 h-2 bg-green-500 rounded-full auto-send-indicator"></div>
                                    <span class="text-xs text-gray-600">IA Active</span>
                                </div>
                                <span id="total-count" class="text-xs text-gray-500">15 messages</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button onclick="showQuickActions()" class="p-2 text-gray-400 hover:text-gray-600">
                            <i data-lucide="zap" class="w-5 h-5"></i>
                        </button>
                        <div id="user-avatar" class="w-8 h-8 hormur-gradient rounded-full flex items-center justify-center">
                            <span id="user-initials" class="text-white text-sm font-medium"></span>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Stats Bar -->
                <div class="mt-3 grid grid-cols-5 gap-2 text-center">
                    <div class="bg-green-50 p-2 rounded-lg">
                        <div class="text-sm font-bold text-green-700" id="auto-count">6</div>
                        <div class="text-xs text-green-600">Auto</div>
                    </div>
                    <div class="bg-orange-50 p-2 rounded-lg">
                        <div class="text-sm font-bold text-orange-700" id="review-count">4</div>
                        <div class="text-xs text-orange-600">√Ä valider</div>
                    </div>
                    <div class="bg-red-50 p-2 rounded-lg">
                        <div class="text-sm font-bold text-red-700" id="urgent-count">2</div>
                        <div class="text-xs text-red-600">Urgent</div>
                    </div>
                    <div class="bg-gray-50 p-2 rounded-lg">
                        <div class="text-sm font-bold text-gray-700" id="pending-count">3</div>
                        <div class="text-xs text-gray-600">En attente</div>
                    </div>
                    <div class="bg-blue-50 p-2 rounded-lg">
                        <div class="text-sm font-bold text-blue-700" id="archived-count">125</div>
                        <div class="text-xs text-blue-600">Archiv√©es</div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Tab Navigation -->
        <div class="bg-white border-b sticky top-[140px] z-30">
            <div class="flex overflow-x-auto custom-scrollbar">
                <button onclick="switchTab('dashboard')" id="tab-dashboard" class="tab-active px-4 py-3 text-sm font-medium whitespace-nowrap flex-shrink-0 flex items-center space-x-2">
                    <i data-lucide="layout-dashboard" class="w-4 h-4"></i>
                    <span>Dashboard</span>
                    <span id="dashboard-badge" class="bg-white bg-opacity-20 text-xs px-2 py-1 rounded-full">2</span>
                </button>
                <button onclick="switchTab('auto-send')" id="tab-auto-send" class="tab-inactive px-4 py-3 text-sm font-medium whitespace-nowrap flex-shrink-0 flex items-center space-x-2">
                    <i data-lucide="zap" class="w-4 h-4"></i>
                    <span>Auto-Send</span>
                    <span id="auto-badge" class="bg-green-600 text-white text-xs px-2 py-1 rounded-full">6</span>
                </button>
                <button onclick="switchTab('validation')" id="tab-validation" class="tab-inactive px-4 py-3 text-sm font-medium whitespace-nowrap flex-shrink-0 flex items-center space-x-2">
                    <i data-lucide="eye" class="w-4 h-4"></i>
                    <span>√Ä Valider</span>
                    <span id="validation-badge" class="bg-orange-600 text-white text-xs px-2 py-1 rounded-full">4</span>
                </button>
                <button onclick="switchTab('archives')" id="tab-archives" class="tab-inactive px-4 py-3 text-sm font-medium whitespace-nowrap flex-shrink-0 flex items-center space-x-2">
                    <i data-lucide="archive" class="w-4 h-4"></i>
                    <span>Archives</span>
                    <span id="archive-badge" class="bg-blue-600 text-white text-xs px-2 py-1 rounded-full">125</span>
                </button>
                <button onclick="switchTab('all')" id="tab-all" class="tab-inactive px-4 py-3 text-sm font-medium whitespace-nowrap flex-shrink-0 flex items-center space-x-2">
                    <i data-lucide="list" class="w-4 h-4"></i>
                    <span>Tous</span>
                </button>
            </div>
        </div>

        <!-- Content Container -->
        <div class="pb-20">
            <!-- Dashboard Tab -->
            <div id="content-dashboard" class="p-4 space-y-4">
                <!-- Urgent Actions Card -->
                <div id="urgent-actions" class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <h3 class="font-medium text-red-800 mb-3 flex items-center">
                        <i data-lucide="alert-triangle" class="w-5 h-5 mr-2"></i>
                        Actions Urgentes
                        <span class="ml-2 bg-red-600 text-white text-xs px-2 py-1 rounded-full" id="urgent-actions-count">2</span>
                    </h3>
                    <div id="urgent-messages" class="space-y-2">
                        <!-- Urgent messages will be loaded here -->
                    </div>
                </div>

                <!-- Auto-Send Surveillance -->
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <h3 class="font-medium text-green-800 mb-3 flex items-center">
                        <i data-lucide="bot" class="w-5 h-5 mr-2"></i>
                        Surveillance Auto-Send (30min)
                        <span class="ml-2 bg-green-600 text-white text-xs px-2 py-1 rounded-full" id="surveillance-count">3</span>
                    </h3>
                    <div id="surveillance-auto-send" class="space-y-2">
                        <!-- Recent auto-send messages will be loaded here -->
                    </div>
                </div>

                <!-- Quick Stats for Today -->
                <div class="bg-white rounded-lg p-4 border">
                    <h3 class="font-medium text-gray-900 mb-3 flex items-center">
                        <i data-lucide="trending-up" class="w-5 h-5 mr-2"></i>
                        Statistiques du jour
                    </h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-600" id="today-auto">6</div>
                            <div class="text-sm text-gray-600">Auto-envoy√©s</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-purple-600" id="ai-accuracy">94%</div>
                            <div class="text-sm text-gray-600">Pr√©cision IA</div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="refreshMessages()" class="bg-white p-4 rounded-lg shadow-sm border flex items-center space-x-3 hover:bg-gray-50">
                        <i data-lucide="refresh-cw" class="w-6 h-6 text-blue-600"></i>
                        <div class="text-left">
                            <div class="font-medium text-gray-900">Actualiser</div>
                            <div class="text-sm text-gray-500">Nouveaux messages</div>
                        </div>
                    </button>
                    <button onclick="showArchiveManager()" class="bg-white p-4 rounded-lg shadow-sm border flex items-center space-x-3 hover:bg-gray-50">
                        <i data-lucide="archive" class="w-6 h-6 text-indigo-600"></i>
                        <div class="text-left">
                            <div class="font-medium text-gray-900">Archivage</div>
                            <div class="text-sm text-gray-500">G√©rer les archives</div>
                        </div>
                    </button>
                </div>
            </div>

            <!-- Auto-Send Tab -->
            <div id="content-auto-send" class="hidden p-4">
                <div class="mb-4 bg-green-50 border border-green-200 rounded-lg p-3">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-medium text-green-800">Surveillance Auto-Send Active</h3>
                            <p class="text-sm text-green-600">Messages envoy√©s automatiquement par l'IA</p>
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-bold text-green-700" id="auto-send-today">6</div>
                            <div class="text-xs text-green-600">Aujourd'hui</div>
                        </div>
                    </div>
                </div>
                
                <!-- Auto-Archive Settings -->
                <div class="mb-4 bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <h4 class="font-medium text-blue-800 mb-2">Archivage automatique</h4>
                    <div class="flex items-center space-x-3">
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" id="auto-archive-enabled" class="rounded" checked>
                            <span class="text-sm text-blue-700">Activer l'archivage auto apr√®s</span>
                        </label>
                        <select id="auto-archive-delay" class="text-sm border rounded px-2 py-1">
                            <option value="24">24h</option>
                            <option value="48" selected>48h</option>
                            <option value="72">72h</option>
                            <option value="168">7 jours</option>
                        </select>
                    </div>
                </div>

                <div id="auto-send-messages" class="space-y-3">
                    <!-- Auto-send messages will be loaded here -->
                </div>
            </div>

            <!-- Validation Tab -->
            <div id="content-validation" class="hidden p-4">
                <div class="mb-4 bg-orange-50 border border-orange-200 rounded-lg p-3">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-medium text-orange-800">Messages √† Valider</h3>
                            <p class="text-sm text-orange-600">N√©cessitent une intervention humaine</p>
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-bold text-orange-700" id="validation-today">4</div>
                            <div class="text-xs text-orange-600">En attente</div>
                        </div>
                    </div>
                </div>
                <div id="validation-messages" class="space-y-3">
                    <!-- Validation messages will be loaded here -->
                </div>
            </div>

            <!-- Archives Tab -->
            <div id="content-archives" class="hidden p-4">
                <div class="mb-4 bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-medium text-blue-800">Archives</h3>
                            <p class="text-sm text-blue-600">Conversations termin√©es et archiv√©es</p>
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-bold text-blue-700" id="total-archived">125</div>
                            <div class="text-xs text-blue-600">Total archiv√©es</div>
                        </div>
                    </div>
                </div>

                <!-- Archive Filters -->
                <div class="mb-4 flex space-x-2 overflow-x-auto custom-scrollbar">
                    <select id="archive-period-filter" class="flex-shrink-0 px-3 py-2 border border-gray-300 rounded-lg text-sm">
                        <option value="all">Toute p√©riode</option>
                        <option value="today">Aujourd'hui</option>
                        <option value="week">Cette semaine</option>
                        <option value="month">Ce mois</option>
                        <option value="quarter">Ce trimestre</option>
                    </select>
                    <select id="archive-category-filter" class="flex-shrink-0 px-3 py-2 border border-gray-300 rounded-lg text-sm">
                        <option value="all">Toutes cat√©gories</option>
                        <option value="artiste">Artistes</option>
                        <option value="hote">H√¥tes</option>
                        <option value="spectateur">Spectateurs</option>
                        <option value="partenariat">Partenariats</option>
                    </select>
                    <button onclick="exportArchives()" class="flex-shrink-0 px-3 py-2 bg-indigo-600 text-white rounded-lg text-sm hover:bg-indigo-700">
                        <i data-lucide="download" class="w-4 h-4 inline mr-1"></i>
                        Exporter
                    </button>
                </div>

                <div id="archived-messages" class="space-y-3">
                    <!-- Archived messages will be loaded here -->
                </div>
            </div>

            <!-- All Messages Tab -->
            <div id="content-all" class="hidden p-4">
                <!-- Search Bar -->
                <div class="mb-4">
                    <div class="relative">
                        <i data-lucide="search" class="absolute left-3 top-3 w-4 h-4 text-gray-400"></i>
                        <input
                            type="text"
                            id="search-input"
                            placeholder="Rechercher..."
                            class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                        />
                    </div>
                </div>

                <!-- Filters -->
                <div class="mb-4 flex space-x-2 overflow-x-auto custom-scrollbar">
                    <select id="status-filter" class="flex-shrink-0 px-3 py-2 border border-gray-300 rounded-lg text-sm">
                        <option value="all">Tous statuts</option>
                        <option value="auto-sent">Auto-envoy√©s</option>
                        <option value="manual-review">√Ä valider</option>
                        <option value="pending">En attente</option>
                        <option value="spam">Spam</option>
                        <option value="archived">Archiv√©s</option>
                    </select>
                    <select id="category-filter" class="flex-shrink-0 px-3 py-2 border border-gray-300 rounded-lg text-sm">
                        <option value="all">Toutes cat√©gories</option>
                        <option value="artiste">Artistes</option>
                        <option value="hote">H√¥tes</option>
                        <option value="spectateur">Spectateurs</option>
                        <option value="partenariat">Partenariats</option>
                    </select>
                    <button onclick="bulkArchive()" class="flex-shrink-0 px-3 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700 flex items-center space-x-1">
                        <i data-lucide="archive" class="w-4 h-4"></i>
                        <span>Archiver s√©lection</span>
                    </button>
                </div>

                <div id="all-messages" class="space-y-3">
                    <!-- All messages will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Message Detail Modal -->
        <div id="message-modal" class="fixed inset-0 modal-overlay z-50 hidden">
            <div class="min-h-screen px-4 flex items-end sm:items-center justify-center">
                <div class="bg-white rounded-t-2xl sm:rounded-2xl shadow-xl w-full max-w-2xl max-h-[90vh] overflow-hidden slide-in-right">
                    <div class="sticky top-0 bg-white border-b px-4 py-3 flex items-center justify-between">
                        <h3 class="font-semibold text-gray-900 flex items-center">
                            <i data-lucide="message-circle" class="w-5 h-5 mr-2"></i>
                            D√©tails du message
                        </h3>
                        <div class="flex items-center space-x-2">
                            <button onclick="archiveMessage(selectedMessage?.id)" class="text-blue-600 hover:text-blue-800" title="Archiver">
                                <i data-lucide="archive" class="w-5 h-5"></i>
                            </button>
                            <button onclick="closeMessageModal()" class="text-gray-400 hover:text-gray-600">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                    </div>
                    <div id="message-detail-content" class="p-4 overflow-y-auto custom-scrollbar" style="max-height: calc(90vh - 60px);">
                        <!-- Message details will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Archive Manager Modal -->
        <div id="archive-manager-modal" class="fixed inset-0 modal-overlay z-50 hidden">
            <div class="min-h-screen px-4 flex items-center justify-center">
                <div class="bg-white rounded-2xl shadow-xl w-full max-w-4xl max-h-[90vh] overflow-hidden">
                    <div class="sticky top-0 bg-white border-b px-4 py-3 flex items-center justify-between">
                        <h3 class="font-semibold text-gray-900 flex items-center">
                            <i data-lucide="archive" class="w-5 h-5 mr-2"></i>
                            Gestionnaire d'Archives
                        </h3>
                        <button onclick="closeArchiveManager()" class="text-gray-400 hover:text-gray-600">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                    <div id="archive-manager-content" class="p-4 overflow-y-auto custom-scrollbar" style="max-height: calc(90vh - 60px);">
                        <!-- Archive manager content will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions Modal -->
        <div id="quick-actions-modal" class="fixed inset-0 modal-overlay z-50 hidden">
            <div class="min-h-screen px-4 flex items-end justify-center">
                <div class="bg-white rounded-t-2xl shadow-xl w-full max-w-sm mb-0 slide-in-right">
                    <div class="p-4">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-semibold text-gray-900">Actions Rapides</h3>
                            <button onclick="closeQuickActions()" class="text-gray-400">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                        <div class="space-y-3">
                            <button onclick="refreshMessages(); closeQuickActions();" class="w-full p-3 bg-blue-50 text-blue-700 rounded-lg flex items-center space-x-3">
                                <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                                <span>Actualiser les messages</span>
                            </button>
                            <button onclick="showArchiveManager(); closeQuickActions();" class="w-full p-3 bg-indigo-50 text-indigo-700 rounded-lg flex items-center space-x-3">
                                <i data-lucide="archive" class="w-5 h-5"></i>
                                <span>Gestionnaire d'archives</span>
                            </button>
                            <button onclick="exportData(); closeQuickActions();" class="w-full p-3 bg-green-50 text-green-700 rounded-lg flex items-center space-x-3">
                                <i data-lucide="download" class="w-5 h-5"></i>
                                <span>Exporter les donn√©es</span>
                            </button>
                            <button onclick="showSettings(); closeQuickActions();" class="w-full p-3 bg-gray-50 text-gray-700 rounded-lg flex items-center space-x-3">
                                <i data-lucide="settings" class="w-5 h-5"></i>
                                <span>Param√®tres</span>
                            </button>
                            <button onclick="logout(); closeQuickActions();" class="w-full p-3 bg-red-50 text-red-700 rounded-lg flex items-center space-x-3">
                                <i data-lucide="log-out" class="w-5 h-5"></i>
                                <span>D√©connexion</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Toast -->
        <div id="toast-container" class="fixed bottom-4 left-4 right-4 z-50 space-y-2"></div>
    </div>

    <script>
        // Configuration utilisateurs Hormur
        const AUTHORIZED_USERS = {
            'eleonore@hormur.com': {
                password: 'Hormur2025!',
                name: 'El√©onore',
                role: 'Responsable Relations Artistes',
                signature: `Cordialement,\n\nEl√©onore\nResponsable Relations Artistes\nHormur - Cr√©ons ensemble des moments uniques\n\nüìß eleonore@hormur.com\nüåê www.hormur.com\nüé≠ "L'art se vit partout, cr√©ons l'inattendu"`,
                specialties: ['artistes', '√©v√©nements', 'cr√©ativit√©'],
                color: '#e11d48',
                brevoAgentId: '6223aae91d1bcc698a514cd6_67d814247e4a70279409c965'
            },
            'martin.jeudy@hormur.com': {
                password: 'Hormur2025!',
                name: 'Martin',
                role: 'Responsable Partenariats Lieux',
                signature: `Bien √† vous,\n\nMartin\nResponsable Partenariats Lieux\nHormur - Transformons vos espaces en sc√®nes\n\nüìß martin.jeudy@hormur.com\nüåê www.hormur.com\nüè° "Votre lieu a une histoire, donnons-lui une sc√®ne"`,
                specialties: ['lieux', 'h√¥tes', 'logistique', 'partenariats'],
                color: '#059669',
                brevoAgentId: '6223aae91d1bcc698a514cd6_67a0bf5edbc8f653740f31c8'
            }
        };

        // Messages de d√©monstration enrichis avec syst√®me d'archivage
        let messages = [
            // Messages actifs
            {
                id: 1,
                from: 'artiste.piano@hotmail.com',
                subject: 'Probl√®me de paiement - √©v√©nement du mois dernier',
                content: 'Bonjour, je n\'ai pas re√ßu mon paiement pour l\'√©v√©nement du mois dernier (Concert piano chez Sophie, 15 mai). Mon √©v√©nement s\'est bien pass√©, il y avait 12 spectateurs. Pouvez-vous v√©rifier mon compte Stripe Connect ?',
                receivedAt: '2025-06-07 13:15',
                status: 'manual-review',
                category: 'paiement',
                priority: 'high',
                aiResponse: 'Bonjour,\n\nJe comprends votre pr√©occupation concernant le paiement de votre √©v√©nement du 15 mai.\n\nSelon nos informations, les virements Stripe Connect sont automatiquement d√©clench√©s dans les 7 √† 14 jours ouvr√©s apr√®s l\'√©v√©nement. Je vais v√©rifier imm√©diatement votre dossier dans notre syst√®me.\n\n√âl√©onore\nResponsable Relations Artistes\nHormur',
                confidence: 88,
                assignedTo: 'eleonore',
                escalationReason: 'Probl√®me financier n√©cessitant v√©rification comptable',
                timeReceived: new Date().getTime() - 3600000, // 1h ago
                archived: false
            },
            {
                id: 2,
                from: 'contact@ehpad-soleil.fr',
                subject: 'Partenariat EHPAD - √©v√©nements culturels r√©sidents',
                content: 'Bonjour, nous sommes l\'EHPAD Les Jardins du Soleil √† Lyon (120 r√©sidents). Nous aimerions proposer des √©v√©nements culturels r√©guliers √† nos r√©sidents. Comment √©tablir un partenariat avec Hormur ? Tarification sp√©ciale ?',
                receivedAt: '2025-06-07 12:30',
                status: 'manual-review',
                category: 'partenariat',
                priority: 'high',
                aiResponse: 'Bonjour,\n\nNous serions ravis de d√©velopper un partenariat avec votre EHPAD !\n\nMartin\nResponsable Partenariats Lieux\nHormur',
                confidence: 92,
                assignedTo: 'martin',
                escalationReason: 'Opportunit√© commerciale B2B importante',
                timeReceived: new Date().getTime() - 2400000, // 40min ago
                archived: false
            },
            {
                id: 3,
                from: 'marie.spectateur@gmail.com',
                subject: 'Question sur l\'√©v√©nement jazz pr√©vu chez M. Martin',
                content: 'Bonjour, je voudrais savoir si l\'√©v√©nement de concert jazz pr√©vu chez M. Martin est toujours d\'actualit√© ? J\'ai achet√© mes places il y a une semaine.',
                receivedAt: '2025-06-07 14:30',
                status: 'auto-sent',
                category: 'spectateur',
                priority: 'medium',
                aiResponse: 'Bonjour Marie,\n\nMerci pour votre message ! Le concert jazz est bien maintenu comme pr√©vu.\n\nCordialement,\nL\'√©quipe Hormur',
                confidence: 95,
                autoSentAt: new Date().getTime() - 600000, // 10min ago
                timeReceived: new Date().getTime() - 900000, // 15min ago
                archived: false
            },
            {
                id: 4,
                from: 'sophie.comedienne@gmail.com',
                subject: 'Cr√©ation projet th√©√¢tre intimiste',
                content: 'Bonjour, je cherche un lieu pour une repr√©sentation th√©√¢trale intimiste pour 20 personnes maximum. Comment bien remplir mon profil ?',
                receivedAt: '2025-06-07 09:20',
                status: 'auto-sent',
                category: 'artiste',
                priority: 'medium',
                aiResponse: 'Bonjour Sophie !\n\nTon projet sonne passionnant ! Pour cr√©er ton projet :\n1. Va sur https://hormur.com/projet/new\n\n√âl√©onore\nResponsable Relations Artistes\nHormur',
                confidence: 94,
                autoSentAt: new Date().getTime() - 300000, // 5min ago
                timeReceived: new Date().getTime() - 600000, // 10min ago
                archived: false
            },
            {
                id: 5,
                from: 'crypto.winner@tempmail.com',
                subject: 'URGENT: Gagnez des Bitcoin maintenant!',
                content: 'F√©licitations! Vous avez √©t√© s√©lectionn√© pour gagner 5 Bitcoin GRATUITEMENT!',
                receivedAt: '2025-06-07 11:30',
                status: 'spam',
                category: 'spam',
                priority: 'low',
                confidence: 0,
                spamScore: 95,
                spamIndicators: ['Mots-cl√©s crypto', 'Urgence artificielle', 'Domaine temporaire'],
                archived: false
            }
        ];

        // Messages archiv√©s (exemple)
        let archivedMessages = [
            {
                id: 101,
                from: 'ancien.artiste@gmail.com',
                subject: 'Demande d\'informations sur les lieux disponibles',
                content: 'Bonjour, je cherche des lieux pour mes concerts de piano...',
                receivedAt: '2025-06-05 10:30',
                status: 'sent',
                category: 'artiste',
                priority: 'medium',
                aiResponse: 'Bonjour ! Nous avons plusieurs lieux parfaits...',
                confidence: 96,
                archived: true,
                archivedAt: new Date().getTime() - 86400000, // 1 day ago
                archivedBy: 'eleonore'
            },
            // Ajouter plus d'exemples d'archives...
        ];

        let currentTab = 'dashboard';
        let selectedMessage = null;
        let currentUser = null;

        // Archive Management System
        class ArchiveManager {
            constructor() {
                this.autoArchiveEnabled = true;
                this.autoArchiveDelay = 48; // hours
                this.maxActiveMessages = 100; // Limite de messages actifs avant archivage forc√©
            }

            // Archiver un message sp√©cifique
            archiveMessage(messageId, userId = null) {
                const messageIndex = messages.findIndex(m => m.id === messageId);
                if (messageIndex === -1) return false;

                const message = messages[messageIndex];
                message.archived = true;
                message.archivedAt = new Date().getTime();
                message.archivedBy = userId || currentUser?.email || 'system';

                // D√©placer vers les archives
                archivedMessages.unshift(message);
                messages.splice(messageIndex, 1);

                this.saveToLocalStorage();
                return true;
            }

            // Restaurer un message des archives
            unarchiveMessage(messageId) {
                const archiveIndex = archivedMessages.findIndex(m => m.id === messageId);
                if (archiveIndex === -1) return false;

                const message = archivedMessages[archiveIndex];
                message.archived = false;
                delete message.archivedAt;
                delete message.archivedBy;

                // Remettre dans les messages actifs
                messages.unshift(message);
                archivedMessages.splice(archiveIndex, 1);

                this.saveToLocalStorage();
                return true;
            }

            // Archivage automatique bas√© sur l'√¢ge et le statut
            performAutoArchive() {
                if (!this.autoArchiveEnabled) return;

                const cutoffTime = new Date().getTime() - (this.autoArchiveDelay * 60 * 60 * 1000);
                let archivedCount = 0;

                // Archiver les messages anciens selon les crit√®res
                messages.forEach((message, index) => {
                    const shouldArchive = 
                        // Messages auto-envoy√©s anciens
                        (message.status === 'auto-sent' && message.autoSentAt && message.autoSentAt < cutoffTime) ||
                        // Messages envoy√©s manuellement anciens
                        (message.status === 'sent' && message.timeReceived < cutoffTime) ||
                        // Spams anciens
                        (message.status === 'spam' && message.timeReceived < cutoffTime);

                    if (shouldArchive) {
                        this.archiveMessage(message.id, 'auto-system');
                        archivedCount++;
                    }
                });

                // Archivage forc√© si trop de messages actifs
                if (messages.length > this.maxActiveMessages) {
                    const oldestMessages = messages
                        .filter(m => ['sent', 'auto-sent'].includes(m.status))
                        .sort((a, b) => (a.timeReceived || 0) - (b.timeReceived || 0))
                        .slice(0, messages.length - this.maxActiveMessages);

                    oldestMessages.forEach(message => {
                        this.archiveMessage(message.id, 'auto-system');
                        archivedCount++;
                    });
                }

                if (archivedCount > 0) {
                    showToast(`${archivedCount} messages archiv√©s automatiquement`, 'info');
                }

                return archivedCount;
            }

            // Archivage en lot
            bulkArchive(messageIds, userId = null) {
                let archivedCount = 0;
                messageIds.forEach(id => {
                    if (this.archiveMessage(id, userId)) {
                        archivedCount++;
                    }
                });
                return archivedCount;
            }

            // Nettoyage des archives anciennes
            cleanOldArchives(daysOld = 365) {
                const cutoffTime = new Date().getTime() - (daysOld * 24 * 60 * 60 * 1000);
                const originalLength = archivedMessages.length;
                
                archivedMessages = archivedMessages.filter(message => 
                    !message.archivedAt || message.archivedAt > cutoffTime
                );

                const removedCount = originalLength - archivedMessages.length;
                this.saveToLocalStorage();
                return removedCount;
            }

            // Exporter les archives
            exportArchives(format = 'json') {
                const data = {
                    exportDate: new Date().toISOString(),
                    totalArchived: archivedMessages.length,
                    messages: archivedMessages
                };

                const filename = `hormur_archives_${new Date().toISOString().split('T')[0]}.${format}`;
                
                if (format === 'json') {
                    this.downloadFile(JSON.stringify(data, null, 2), filename, 'application/json');
                } else if (format === 'csv') {
                    this.downloadFile(this.convertToCSV(archivedMessages), filename, 'text/csv');
                }
            }

            // Convertir en CSV
            convertToCSV(messages) {
                const headers = ['ID', 'De', 'Sujet', 'Cat√©gorie', 'Statut', 'Priorit√©', 'Re√ßu le', 'Archiv√© le', 'Archiv√© par'];
                const rows = messages.map(msg => [
                    msg.id,
                    msg.from,
                    msg.subject,
                    msg.category,
                    msg.status,
                    msg.priority,
                    msg.receivedAt,
                    msg.archivedAt ? new Date(msg.archivedAt).toISOString() : '',
                    msg.archivedBy || ''
                ]);

                return [headers, ...rows].map(row => 
                    row.map(field => `"${field}"`).join(',')
                ).join('\n');
            }

            // T√©l√©charger un fichier
            downloadFile(content, filename, mimeType) {
                const blob = new Blob([content], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            // Sauvegarder en localStorage
            saveToLocalStorage() {
                localStorage.setItem('hormur_messages', JSON.stringify(messages));
                localStorage.setItem('hormur_archived_messages', JSON.stringify(archivedMessages));
                localStorage.setItem('hormur_archive_settings', JSON.stringify({
                    autoArchiveEnabled: this.autoArchiveEnabled,
                    autoArchiveDelay: this.autoArchiveDelay,
                    maxActiveMessages: this.maxActiveMessages
                }));
            }

            // Charger depuis localStorage
            loadFromLocalStorage() {
                try {
                    const savedMessages = localStorage.getItem('hormur_messages');
                    const savedArchived = localStorage.getItem('hormur_archived_messages');
                    const savedSettings = localStorage.getItem('hormur_archive_settings');

                    if (savedMessages) {
                        messages = JSON.parse(savedMessages);
                    }
                    if (savedArchived) {
                        archivedMessages = JSON.parse(savedArchived);
                    }
                    if (savedSettings) {
                        const settings = JSON.parse(savedSettings);
                        this.autoArchiveEnabled = settings.autoArchiveEnabled;
                        this.autoArchiveDelay = settings.autoArchiveDelay;
                        this.maxActiveMessages = settings.maxActiveMessages;
                    }
                } catch (error) {
                    console.error('Erreur lors du chargement des archives:', error);
                }
            }

            // Statistiques des archives
            getArchiveStats() {
                const stats = {
                    total: archivedMessages.length,
                    byCategory: {},
                    byStatus: {},
                    byUser: {},
                    thisWeek: 0,
                    thisMonth: 0
                };

                const oneWeekAgo = new Date().getTime() - (7 * 24 * 60 * 60 * 1000);
                const oneMonthAgo = new Date().getTime() - (30 * 24 * 60 * 60 * 1000);

                archivedMessages.forEach(msg => {
                    // Par cat√©gorie
                    stats.byCategory[msg.category] = (stats.byCategory[msg.category] || 0) + 1;
                    
                    // Par statut
                    stats.byStatus[msg.status] = (stats.byStatus[msg.status] || 0) + 1;
                    
                    // Par utilisateur qui a archiv√©
                    if (msg.archivedBy) {
                        stats.byUser[msg.archivedBy] = (stats.byUser[msg.archivedBy] || 0) + 1;
                    }
                    
                    // Par p√©riode
                    if (msg.archivedAt > oneWeekAgo) stats.thisWeek++;
                    if (msg.archivedAt > oneMonthAgo) stats.thisMonth++;
                });

                return stats;
            }
        }

        // Initialiser le gestionnaire d'archives
        const archiveManager = new ArchiveManager();

        // Utility functions
        function timeAgo(timestamp) {
            const now = new Date().getTime();
            const diff = now - timestamp;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return '√Ä l\'instant';
            if (minutes < 60) return `${minutes}min`;
            if (hours < 24) return `${hours}h`;
            if (days < 30) return `${days}j`;
            return `${Math.floor(days / 30)}mois`;
        }

        function getCategoryColor(category) {
            const colors = {
                artiste: 'bg-purple-100 text-purple-800',
                hote: 'bg-green-100 text-green-800',
                spectateur: 'bg-blue-100 text-blue-800',
                paiement: 'bg-red-100 text-red-800',
                partenariat: 'bg-teal-100 text-teal-800',
                spam: 'bg-red-200 text-red-900'
            };
            return colors[category] || 'bg-gray-100 text-gray-800';
        }

        function getCategoryIcon(category) {
            const icons = {
                artiste: 'palette',
                hote: 'home',
                spectateur: 'users',
                paiement: 'credit-card',
                partenariat: 'handshake',
                spam: 'shield'
            };
            return icons[category] || 'message-circle';
        }

        function getPriorityColor(priority) {
            const colors = {
                high: 'text-red-600',
                medium: 'text-orange-600',
                low: 'text-green-600'
            };
            return colors[priority] || 'text-gray-600';
        }

        function getPriorityIcon(priority) {
            const icons = {
                high: 'alert-triangle',
                medium: 'minus-circle',
                low: 'check-circle'
            };
            return icons[priority] || 'circle';
        }

        // Authentication
        function initAuth() {
            const loggedUser = localStorage.getItem('hormur_logged_user');
            if (loggedUser) {
                currentUser = JSON.parse(loggedUser);
                handleUserLogin(currentUser);
            } else {
                showLoginOverlay();
            }
        }

        function handleLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('login-email').value.toLowerCase().trim();
            const password = document.getElementById('login-password').value;
            const errorDiv = document.getElementById('login-error');
            
            if (AUTHORIZED_USERS[email] && AUTHORIZED_USERS[email].password === password) {
                currentUser = { email, ...AUTHORIZED_USERS[email] };
                localStorage.setItem('hormur_logged_user', JSON.stringify(currentUser));
                handleUserLogin(currentUser);
                errorDiv.classList.add('hidden');
            } else {
                errorDiv.classList.remove('hidden');
            }
        }

        function handleUserLogin(user) {
            document.getElementById('user-initials').textContent = user.name.split(' ').map(n => n[0]).join('');
            hideLoginOverlay();
            init();
            showToast(`Bienvenue ${user.name} !`, 'success');
        }

        function showLoginOverlay() {
            document.getElementById('login-overlay').classList.remove('hidden');
            document.getElementById('main-app').classList.add('hidden');
        }

        function hideLoginOverlay() {
            document.getElementById('login-overlay').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
        }

        function logout() {
            localStorage.removeItem('hormur_logged_user');
            currentUser = null;
            showLoginOverlay();
            showToast('D√©connect√© avec succ√®s');
        }

        // Tab management
        function switchTab(tab) {
            currentTab = tab;
            
            // Update tab styling
            document.querySelectorAll('[id^="tab-"]').forEach(t => {
                t.className = t.className.replace('tab-active', 'tab-inactive');
            });
            document.getElementById(`tab-${tab}`).className = 
                document.getElementById(`tab-${tab}`).className.replace('tab-inactive', 'tab-active');
            
            // Update content
            document.querySelectorAll('[id^="content-"]').forEach(c => c.classList.add('hidden'));
            document.getElementById(`content-${tab}`).classList.remove('hidden');
            
            renderCurrentTab();
        }

        function renderCurrentTab() {
            switch(currentTab) {
                case 'dashboard':
                    renderDashboard();
                    break;
                case 'auto-send':
                    renderAutoSendMessages();
                    break;
                case 'validation':
                    renderValidationMessages();
                    break;
                case 'archives':
                    renderArchivedMessages();
                    break;
                case 'all':
                    renderAllMessages();
                    break;
            }
        }

        // Dashboard rendering
        function renderDashboard() {
            renderUrgentMessages();
            renderSurveillanceAutoSend();
        }

        function renderUrgentMessages() {
            const urgentMessages = messages.filter(m => 
                (m.status === 'manual-review' && m.priority === 'high') ||
                (m.status === 'pending' && m.priority === 'high')
            );

            const container = document.getElementById('urgent-messages');
            document.getElementById('urgent-actions-count').textContent = urgentMessages.length;

            if (urgentMessages.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4 text-green-600">
                        <i data-lucide="check-circle" class="w-8 h-8 mx-auto mb-2"></i>
                        <p class="text-sm">Aucune action urgente !</p>
                    </div>
                `;
            } else {
                container.innerHTML = urgentMessages.map(msg => `
                    <div class="message-card bg-white p-3 rounded-lg border border-red-200 ${msg.priority === 'high' ? 'pulse-urgent' : ''}" onclick="openMessageModal(${msg.id})">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-1">
                                    <span class="text-sm font-medium text-gray-900">${msg.from}</span>
                                    <span class="px-2 py-1 text-xs rounded-full ${getCategoryColor(msg.category)}">
                                        ${msg.category}
                                    </span>
                                    <span class="urgent-indicator px-2 py-1 text-xs text-white rounded-full">URGENT</span>
                                </div>
                                <p class="text-sm text-gray-700 line-clamp-2">${msg.subject}</p>
                                <div class="flex items-center justify-between mt-2">
                                    <span class="text-xs text-gray-500">${msg.receivedAt}</span>
                                </div>
                            </div>
                            <div class="flex items-center space-x-1">
                                <button onclick="event.stopPropagation(); archiveMessage(${msg.id})" class="text-blue-600 hover:text-blue-800" title="Archiver">
                                    <i data-lucide="archive" class="w-4 h-4"></i>
                                </button>
                                <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400"></i>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            lucide.createIcons();
        }

        function renderSurveillanceAutoSend() {
            const surveillanceMessages = messages.filter(m => 
                m.status === 'auto-sent' && 
                (new Date().getTime() - (m.autoSentAt || m.timeReceived)) < 1800000 // Last 30min
            ).sort((a, b) => (b.autoSentAt || b.timeReceived) - (a.autoSentAt || a.timeReceived));

            const container = document.getElementById('surveillance-auto-send');
            document.getElementById('surveillance-count').textContent = surveillanceMessages.length;

            if (surveillanceMessages.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4 text-gray-500">
                        <i data-lucide="clock" class="w-8 h-8 mx-auto mb-2"></i>
                        <p class="text-sm">Aucun auto-send r√©cent √† surveiller</p>
                    </div>
                `;
            } else {
                container.innerHTML = surveillanceMessages.map(msg => `
                    <div class="message-card bg-white p-3 rounded-lg border border-green-200" onclick="openMessageModal(${msg.id})">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-1">
                                    <div class="auto-send-badge px-2 py-1 text-xs rounded-full">AUTO</div>
                                    <span class="text-sm font-medium text-gray-900">${msg.from}</span>
                                    <span class="text-xs text-green-600">${msg.confidence}%</span>
                                </div>
                                <p class="text-sm text-gray-700 line-clamp-2">${msg.subject}</p>
                                <div class="flex items-center justify-between mt-2">
                                    <span class="text-xs text-gray-500">Envoy√© ${timeAgo(msg.autoSentAt || msg.timeReceived)}</span>
                                    <div class="flex items-center space-x-2">
                                        <button onclick="event.stopPropagation(); markForReview(${msg.id})" class="text-xs text-orange-600 hover:text-orange-800">
                                            <i data-lucide="eye" class="w-3 h-3 inline mr-1"></i>R√©viser
                                        </button>
                                        <button onclick="event.stopPropagation(); markAsCorrect(${msg.id})" class="text-xs text-green-600 hover:text-green-800">
                                            <i data-lucide="check" class="w-3 h-3 inline mr-1"></i>OK
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400 ml-2"></i>
                        </div>
                    </div>
                `).join('');
            }
            lucide.createIcons();
        }

        // Auto-send messages rendering
        function renderAutoSendMessages() {
            const autoSendMessages = messages.filter(m => m.status === 'auto-sent')
                .sort((a, b) => (b.autoSentAt || b.timeReceived) - (a.autoSentAt || a.timeReceived));

            const container = document.getElementById('auto-send-messages');
            document.getElementById('auto-send-today').textContent = autoSendMessages.length;

            container.innerHTML = autoSendMessages.map(msg => `
                <div class="message-card bg-white p-4 rounded-lg shadow-sm border" onclick="openMessageModal(${msg.id})">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center space-x-2 mb-2">
                                <div class="auto-send-badge px-2 py-1 text-xs rounded-full flex items-center space-x-1">
                                    <i data-lucide="zap" class="w-3 h-3"></i>
                                    <span>AUTO</span>
                                </div>
                                <span class="px-2 py-1 text-xs rounded-full ${getCategoryColor(msg.category)}">
                                    ${msg.category}
                                </span>
                                <span class="text-xs font-medium ${getPriorityColor(msg.priority)}">${msg.confidence}%</span>
                            </div>
                            <div class="mb-2">
                                <h4 class="font-medium text-gray-900">${msg.from}</h4>
                                <p class="text-sm text-gray-700">${msg.subject}</p>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-xs text-gray-500">Envoy√© ${timeAgo(msg.autoSentAt || msg.timeReceived)}</span>
                                <div class="flex items-center space-x-2">
                                    ${(new Date().getTime() - (msg.autoSentAt || msg.timeReceived)) < 1800000 ? `
                                        <span class="px-2 py-1 bg-orange-100 text-orange-700 text-xs rounded-full">
                                            <i data-lucide="clock" class="w-3 h-3 inline mr-1"></i>
                                            Surveillance active
                                        </span>
                                    ` : `
                                        <span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full">
                                            <i data-lucide="check" class="w-3 h-3 inline mr-1"></i>
                                            Valid√©
                                        </span>
                                        <button onclick="event.stopPropagation(); archiveMessage(${msg.id})" class="text-blue-600 hover:text-blue-800" title="Archiver">
                                            <i data-lucide="archive" class="w-4 h-4"></i>
                                        </button>
                                    `}
                                </div>
                            </div>
                        </div>
                        <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400 ml-2"></i>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        // Validation messages rendering
        function renderValidationMessages() {
            const validationMessages = messages.filter(m => m.status === 'manual-review')
                .sort((a, b) => {
                    if (a.priority !== b.priority) {
                        const priorityOrder = { high: 3, medium: 2, low: 1 };
                        return priorityOrder[b.priority] - priorityOrder[a.priority];
                    }
                    return b.timeReceived - a.timeReceived;
                });

            const container = document.getElementById('validation-messages');
            document.getElementById('validation-today').textContent = validationMessages.length;

            container.innerHTML = validationMessages.map(msg => `
                <div class="message-card bg-white p-4 rounded-lg shadow-sm border ${msg.priority === 'high' ? 'priority-high' : msg.priority === 'medium' ? 'priority-medium' : 'priority-low'}" onclick="openMessageModal(${msg.id})">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex-1">
                            <div class="flex items-center space-x-2 mb-2">
                                <span class="px-2 py-1 text-xs rounded-full ${getCategoryColor(msg.category)}">
                                    ${msg.category}
                                </span>
                                <span class="px-2 py-1 text-xs rounded-full ${
                                    msg.priority === 'high' ? 'bg-red-100 text-red-700' :
                                    msg.priority === 'medium' ? 'bg-orange-100 text-orange-700' :
                                    'bg-green-100 text-green-700'
                                }">
                                    <i data-lucide="${getPriorityIcon(msg.priority)}" class="w-3 h-3 inline mr-1"></i>
                                    ${msg.priority === 'high' ? 'Urgent' : msg.priority === 'medium' ? 'Moyen' : 'Faible'}
                                </span>
                                ${msg.assignedTo ? `
                                    <span class="px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded-full">
                                        ${msg.assignedTo === 'martin' ? 'üè°' : 'üé®'} ${msg.assignedTo}
                                    </span>
                                ` : ''}
                            </div>
                            <div class="mb-2">
                                <h4 class="font-medium text-gray-900">${msg.from}</h4>
                                <p class="text-sm text-gray-700">${msg.subject}</p>
                            </div>
                            <p class="text-sm text-gray-600 line-clamp-3 mb-3">${msg.content}</p>
                            ${msg.escalationReason ? `
                                <div class="bg-yellow-50 border border-yellow-200 rounded p-2 mb-3">
                                    <p class="text-xs text-yellow-800">
                                        <i data-lucide="alert-triangle" class="w-3 h-3 inline mr-1"></i>
                                        ${msg.escalationReason}
                                    </p>
                                </div>
                            ` : ''}
                        </div>
                        <div class="flex flex-col items-center space-y-2">
                            <button onclick="event.stopPropagation(); archiveMessage(${msg.id})" class="text-blue-600 hover:text-blue-800" title="Archiver">
                                <i data-lucide="archive" class="w-4 h-4"></i>
                            </button>
                            <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400"></i>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button
                            onclick="event.stopPropagation(); quickApprove(${msg.id})"
                            class="flex-1 bg-green-100 text-green-700 py-2 px-3 rounded-lg text-sm font-medium hover:bg-green-200 transition-colors flex items-center justify-center space-x-1"
                        >
                            <i data-lucide="check" class="w-4 h-4"></i>
                            <span>Approuver</span>
                        </button>
                        <button
                            onclick="event.stopPropagation(); quickReject(${msg.id})"
                            class="flex-1 bg-red-100 text-red-700 py-2 px-3 rounded-lg text-sm font-medium hover:bg-red-200 transition-colors flex items-center justify-center space-x-1"
                        >
                            <i data-lucide="x" class="w-4 h-4"></i>
                            <span>Rejeter</span>
                        </button>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        // Archived messages rendering
        function renderArchivedMessages() {
            const periodFilter = document.getElementById('archive-period-filter')?.value || 'all';
            const categoryFilter = document.getElementById('archive-category-filter')?.value || 'all';
            
            let filteredArchives = archivedMessages;

            // Filtrer par p√©riode
            if (periodFilter !== 'all') {
                const now = new Date().getTime();
                let cutoffTime;
                
                switch(periodFilter) {
                    case 'today':
                        cutoffTime = now - 24 * 60 * 60 * 1000;
                        break;
                    case 'week':
                        cutoffTime = now - 7 * 24 * 60 * 60 * 1000;
                        break;
                    case 'month':
                        cutoffTime = now - 30 * 24 * 60 * 60 * 1000;
                        break;
                    case 'quarter':
                        cutoffTime = now - 90 * 24 * 60 * 60 * 1000;
                        break;
                }
                
                filteredArchives = filteredArchives.filter(msg => 
                    msg.archivedAt && msg.archivedAt > cutoffTime
                );
            }

            // Filtrer par cat√©gorie
            if (categoryFilter !== 'all') {
                filteredArchives = filteredArchives.filter(msg => msg.category === categoryFilter);
            }

            const container = document.getElementById('archived-messages');
            document.getElementById('total-archived').textContent = archivedMessages.length;

            if (filteredArchives.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i data-lucide="archive" class="w-12 h-12 mx-auto mb-4 text-gray-300"></i>
                        <p>Aucune archive trouv√©e pour ces crit√®res</p>
                    </div>
                `;
            } else {
                container.innerHTML = filteredArchives.map(msg => `
                    <div class="message-card bg-gray-50 p-4 rounded-lg border" onclick="openMessageModal(${msg.id}, true)">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-2">
                                    <span class="archived-badge px-2 py-1 text-xs rounded-full">ARCHIV√â</span>
                                    <span class="px-2 py-1 text-xs rounded-full ${getCategoryColor(msg.category)}">
                                        ${msg.category}
                                    </span>
                                    <span class="text-xs text-gray-500">
                                        ${msg.archivedAt ? timeAgo(msg.archivedAt) : ''}
                                    </span>
                                </div>
                                <div class="mb-2">
                                    <h4 class="font-medium text-gray-700">${msg.from}</h4>
                                    <p class="text-sm text-gray-600">${msg.subject}</p>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-xs text-gray-500">Re√ßu: ${msg.receivedAt}</span>
                                    <span class="text-xs text-gray-500">
                                        Archiv√© par: ${msg.archivedBy || 'Syst√®me'}
                                    </span>
                                </div>
                            </div>
                            <div class="flex flex-col items-center space-y-2">
                                <button onclick="event.stopPropagation(); unarchiveMessage(${msg.id})" class="text-green-600 hover:text-green-800" title="D√©sarchiver">
                                    <i data-lucide="archive-restore" class="w-4 h-4"></i>
                                </button>
                                <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400"></i>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            lucide.createIcons();
        }

        // All messages rendering
        function renderAllMessages() {
            const filteredMessages = getFilteredMessages();
            const container = document.getElementById('all-messages');

            container.innerHTML = filteredMessages.map(msg => `
                <div class="message-card bg-white p-4 rounded-lg shadow-sm border ${msg.archived ? 'archive-transition archived' : ''}" onclick="openMessageModal(${msg.id}, ${msg.archived})">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center space-x-2 mb-2">
                                <i data-lucide="${getCategoryIcon(msg.category)}" class="w-4 h-4 text-gray-500"></i>
                                <span class="px-2 py-1 text-xs rounded-full ${getCategoryColor(msg.category)}">
                                    ${msg.category}
                                </span>
                                <span class="text-xs ${getPriorityColor(msg.priority)}">${msg.priority}</span>
                                ${msg.status === 'auto-sent' ? '<div class="auto-send-badge px-2 py-1 text-xs rounded-full">AUTO</div>' : ''}
                                ${msg.archived ? '<div class="archived-badge px-2 py-1 text-xs rounded-full">ARCHIV√â</div>' : ''}
                            </div>
                            <div class="mb-2">
                                <h4 class="font-medium text-gray-900">${msg.from}</h4>
                                <p class="text-sm text-gray-700">${msg.subject}</p>
                            </div>
                            <p class="text-sm text-gray-600 line-clamp-2 mb-2">${msg.content}</p>
                            <div class="flex items-center justify-between">
                                <span class="text-xs text-gray-500">${msg.receivedAt}</span>
                                <span class="text-xs ${
                                    msg.status === 'auto-sent' ? 'text-green-600' :
                                    msg.status === 'manual-review' ? 'text-orange-600' :
                                    msg.status === 'spam' ? 'text-red-600' : 'text-gray-600'
                                }">
                                    ${msg.status === 'auto-sent' ? 'Auto-envoy√©' :
                                      msg.status === 'manual-review' ? '√Ä valider' :
                                      msg.status === 'spam' ? 'Spam' : 
                                      msg.status === 'sent' ? 'Envoy√©' : 'En attente'}
                                </span>
                            </div>
                        </div>
                        <div class="flex flex-col items-center space-y-2">
                            ${!msg.archived ? `
                                <button onclick="event.stopPropagation(); archiveMessage(${msg.id})" class="text-blue-600 hover:text-blue-800" title="Archiver">
                                    <i data-lucide="archive" class="w-4 h-4"></i>
                                </button>
                            ` : `
                                <button onclick="event.stopPropagation(); unarchiveMessage(${msg.id})" class="text-green-600 hover:text-green-800" title="D√©sarchiver">
                                    <i data-lucide="archive-restore" class="w-4 h-4"></i>
                                </button>
                            `}
                            <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400"></i>
                        </div>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function getFilteredMessages() {
            const statusFilter = document.getElementById('status-filter')?.value || 'all';
            const categoryFilter = document.getElementById('category-filter')?.value || 'all';
            const searchTerm = document.getElementById('search-input')?.value.toLowerCase() || '';

            // Combine active and archived messages for "all" view
            const allMessages = statusFilter === 'archived' ? archivedMessages : 
                               statusFilter === 'all' ? [...messages, ...archivedMessages] : messages;

            return allMessages.filter(msg => {
                const matchesStatus = statusFilter === 'all' || 
                                    (statusFilter === 'archived' && msg.archived) ||
                                    (statusFilter !== 'archived' && msg.status === statusFilter);
                const matchesCategory = categoryFilter === 'all' || msg.category === categoryFilter;
                const matchesSearch = !searchTerm || 
                    msg.from.toLowerCase().includes(searchTerm) ||
                    msg.subject.toLowerCase().includes(searchTerm) ||
                    msg.content.toLowerCase().includes(searchTerm);
                
                return matchesStatus && matchesCategory && matchesSearch;
            }).sort((a, b) => {
                // Sort by priority first, then by time
                const priorityOrder = { high: 3, medium: 2, low: 1 };
                if (priorityOrder[a.priority] !== priorityOrder[b.priority]) {
                    return priorityOrder[b.priority] - priorityOrder[a.priority];
                }
                const aTime = a.archivedAt || a.timeReceived || new Date(a.receivedAt).getTime();
                const bTime = b.archivedAt || b.timeReceived || new Date(b.receivedAt).getTime();
                return bTime - aTime;
            });
        }

        // Archive functions
        function archiveMessage(messageId) {
            if (archiveManager.archiveMessage(messageId, currentUser?.email)) {
                updateStats();
                renderCurrentTab();
                showToast('Message archiv√© avec succ√®s', 'success');
                if (selectedMessage?.id === messageId) {
                    closeMessageModal();
                }
            }
        }

        function unarchiveMessage(messageId) {
            if (archiveManager.unarchiveMessage(messageId)) {
                updateStats();
                renderCurrentTab();
                showToast('Message restaur√© des archives', 'success');
                if (selectedMessage?.id === messageId) {
                    closeMessageModal();
                }
            }
        }

        function bulkArchive() {
            // Impl√©menter l'archivage en lot des messages s√©lectionn√©s
            showToast('Archivage en lot en d√©veloppement', 'info');
        }

        function exportArchives() {
            archiveManager.exportArchives('json');
            showToast('Export des archives d√©marr√©', 'info');
        }

        function exportData() {
            // Exporter toutes les donn√©es
            const allData = {
                exportDate: new Date().toISOString(),
                activeMessages: messages,
                archivedMessages: archivedMessages,
                stats: archiveManager.getArchiveStats()
            };
            
            archiveManager.downloadFile(
                JSON.stringify(allData, null, 2), 
                `hormur_export_${new Date().toISOString().split('T')[0]}.json`, 
                'application/json'
            );
            showToast('Export complet termin√©', 'success');
        }

        // Archive Manager Modal
        function showArchiveManager() {
            const stats = archiveManager.getArchiveStats();
            
            document.getElementById('archive-manager-content').innerHTML = `
                <div class="space-y-6">
                    <!-- Statistiques des archives -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-blue-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-blue-700">${stats.total}</div>
                            <div class="text-sm text-blue-600">Total archiv√©es</div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-green-700">${stats.thisWeek}</div>
                            <div class="text-sm text-green-600">Cette semaine</div>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-purple-700">${stats.thisMonth}</div>
                            <div class="text-sm text-purple-600">Ce mois</div>
                        </div>
                        <div class="bg-orange-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-orange-700">${messages.length}</div>
                            <div class="text-sm text-orange-600">Messages actifs</div>
                        </div>
                    </div>

                    <!-- Param√®tres d'archivage -->
                    <div class="bg-white border rounded-lg p-4">
                        <h4 class="font-medium text-gray-900 mb-4">Param√®tres d'archivage automatique</h4>
                        <div class="space-y-4">
                            <div class="flex items-center space-x-3">
                                <input type="checkbox" id="auto-archive-setting" ${archiveManager.autoArchiveEnabled ? 'checked' : ''} class="rounded">
                                <label for="auto-archive-setting" class="text-sm text-gray-700">Activer l'archivage automatique</label>
                            </div>
                            <div class="flex items-center space-x-3">
                                <label class="text-sm text-gray-700">D√©lai d'archivage :</label>
                                <select id="archive-delay-setting" class="border rounded px-3 py-1 text-sm">
                                    <option value="24" ${archiveManager.autoArchiveDelay === 24 ? 'selected' : ''}>24 heures</option>
                                    <option value="48" ${archiveManager.autoArchiveDelay === 48 ? 'selected' : ''}>48 heures</option>
                                    <option value="72" ${archiveManager.autoArchiveDelay === 72 ? 'selected' : ''}>72 heures</option>
                                    <option value="168" ${archiveManager.autoArchiveDelay === 168 ? 'selected' : ''}>7 jours</option>
                                </select>
                            </div>
                            <div class="flex items-center space-x-3">
                                <label class="text-sm text-gray-700">Limite messages actifs :</label>
                                <input type="number" id="max-active-setting" value="${archiveManager.maxActiveMessages}" min="50" max="500" class="border rounded px-3 py-1 text-sm w-20">
                            </div>
                        </div>
                        <div class="mt-4 flex space-x-2">
                            <button onclick="saveArchiveSettings()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-indigo-700">
                                Sauvegarder
                            </button>
                            <button onclick="performManualArchive()" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-green-700">
                                Archivage manuel
                            </button>
                        </div>
                    </div>

                    <!-- Actions sur les archives -->
                    <div class="bg-white border rounded-lg p-4">
                        <h4 class="font-medium text-gray-900 mb-4">Actions sur les archives</h4>
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="exportArchives()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700 flex items-center space-x-2">
                                <i data-lucide="download" class="w-4 h-4"></i>
                                <span>Exporter archives</span>
                            </button>
                            <button onclick="cleanOldArchives()" class="bg-orange-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-orange-700 flex items-center space-x-2">
                                <i data-lucide="trash" class="w-4 h-4"></i>
                                <span>Nettoyer anciennes</span>
                            </button>
                        </div>
                    </div>

                    <!-- R√©partition par cat√©gorie -->
                    <div class="bg-white border rounded-lg p-4">
                        <h4 class="font-medium text-gray-900 mb-4">R√©partition par cat√©gorie</h4>
                        <div class="space-y-2">
                            ${Object.entries(stats.byCategory).map(([category, count]) => `
                                <div class="flex items-center justify-between py-2 border-b border-gray-100 last:border-b-0">
                                    <span class="text-sm text-gray-700 capitalize">${category}</span>
                                    <span class="text-sm font-medium text-gray-900">${count}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('archive-manager-modal').classList.remove('hidden');
            lucide.createIcons();
        }

        function closeArchiveManager() {
            document.getElementById('archive-manager-modal').classList.add('hidden');
        }

        function saveArchiveSettings() {
            const autoEnabled = document.getElementById('auto-archive-setting').checked;
            const delay = parseInt(document.getElementById('archive-delay-setting').value);
            const maxActive = parseInt(document.getElementById('max-active-setting').value);

            archiveManager.autoArchiveEnabled = autoEnabled;
            archiveManager.autoArchiveDelay = delay;
            archiveManager.maxActiveMessages = maxActive;
            archiveManager.saveToLocalStorage();

            showToast('Param√®tres d\'archivage sauvegard√©s', 'success');
        }

        function performManualArchive() {
            const archivedCount = archiveManager.performAutoArchive();
            updateStats();
            renderCurrentTab();
            showToast(`${archivedCount} messages archiv√©s manuellement`, 'success');
        }

        function cleanOldArchives() {
            const removedCount = archiveManager.cleanOldArchives(365); // Supprimer archives > 1 an
            updateStats();
            renderCurrentTab();
            showToast(`${removedCount} anciennes archives supprim√©es`, 'success');
        }

        // Message actions
        function markForReview(messageId) {
            const message = messages.find(m => m.id === messageId);
            if (message) {
                message.status = 'manual-review';
                message.priority = 'medium';
                updateStats();
                renderCurrentTab();
                showToast('Message marqu√© pour r√©vision', 'info');
            }
        }

        function markAsCorrect(messageId) {
            const message = messages.find(m => m.id === messageId);
            if (message) {
                // Marquer comme valid√© et programmer pour archivage
                showToast('Message valid√© comme correct', 'success');
            }
        }

        function quickApprove(messageId) {
            const message = messages.find(m => m.id === messageId);
            if (message) {
                message.status = 'sent';
                updateStats();
                renderCurrentTab();
                showToast('Message approuv√© et envoy√© !', 'success');
            }
        }

        function quickReject(messageId) {
            const message = messages.find(m => m.id === messageId);
            if (message) {
                message.status = 'pending';
                updateStats();
                renderCurrentTab();
                showToast('Message rejet√©', 'error');
            }
        }

        // Message modal
        function openMessageModal(messageId, isArchived = false) {
            const messageSource = isArchived ? archivedMessages : messages;
            selectedMessage = messageSource.find(m => m.id === messageId);
            if (!selectedMessage) return;

            document.getElementById('message-detail-content').innerHTML = `
                <div class="space-y-4">
                    <div class="flex items-center space-x-2 flex-wrap">
                        <span class="px-3 py-1 text-sm rounded-full ${getCategoryColor(selectedMessage.category)}">
                            <i data-lucide="${getCategoryIcon(selectedMessage.category)}" class="w-4 h-4 inline mr-1"></i>
                            ${selectedMessage.category}
                        </span>
                        <span class="px-3 py-1 text-sm rounded-full ${
                            selectedMessage.priority === 'high' ? 'bg-red-100 text-red-700' :
                            selectedMessage.priority === 'medium' ? 'bg-orange-100 text-orange-700' :
                            'bg-green-100 text-green-700'
                        }">
                            <i data-lucide="${getPriorityIcon(selectedMessage.priority)}" class="w-4 h-4 inline mr-1"></i>
                            Priorit√© ${selectedMessage.priority === 'high' ? 'haute' : selectedMessage.priority === 'medium' ? 'moyenne' : 'basse'}
                        </span>
                        ${selectedMessage.status === 'auto-sent' ? `
                            <span class="auto-send-badge px-3 py-1 text-sm rounded-full">
                                <i data-lucide="zap" class="w-4 h-4 inline mr-1"></i>
                                Auto-envoy√©
                            </span>
                        ` : ''}
                        ${selectedMessage.archived ? `
                            <span class="archived-badge px-3 py-1 text-sm rounded-full">
                                <i data-lucide="archive" class="w-4 h-4 inline mr-1"></i>
                                Archiv√©
                            </span>
                        ` : ''}
                    </div>

                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-medium text-gray-900 mb-2">Message original</h4>
                        <div class="space-y-2 text-sm">
                            <div><strong>De :</strong> ${selectedMessage.from}</div>
                            <div><strong>Sujet :</strong> ${selectedMessage.subject}</div>
                            <div><strong>Re√ßu :</strong> ${selectedMessage.receivedAt}</div>
                            ${selectedMessage.archived ? `
                                <div><strong>Archiv√© :</strong> ${selectedMessage.archivedAt ? new Date(selectedMessage.archivedAt).toLocaleString() : 'Date inconnue'}</div>
                                <div><strong>Archiv√© par :</strong> ${selectedMessage.archivedBy || 'Syst√®me'}</div>
                            ` : ''}
                        </div>
                        <div class="mt-3">
                            <p class="text-sm text-gray-700 bg-white p-3 rounded border">${selectedMessage.content}</p>
                        </div>
                    </div>

                    ${selectedMessage.aiResponse ? `
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="font-medium text-blue-900 mb-2 flex items-center">
                                <i data-lucide="bot" class="w-4 h-4 mr-1"></i>
                                R√©ponse IA Hormur
                                ${selectedMessage.confidence ? `<span class="ml-2 text-sm">(${selectedMessage.confidence}% confiance)</span>` : ''}
                            </h4>
                            <div>
                                <textarea
                                    id="ai-response-edit"
                                    class="w-full p-3 border border-blue-200 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm"
                                    rows="8"
                                    ${selectedMessage.archived ? 'readonly' : ''}
                                >${selectedMessage.aiResponse}</textarea>
                            </div>
                        </div>
                    ` : ''}

                    ${selectedMessage.escalationReason ? `
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                            <h4 class="font-medium text-yellow-800 mb-1 flex items-center">
                                <i data-lucide="alert-triangle" class="w-4 h-4 mr-1"></i>
                                Raison de l'escalation
                            </h4>
                            <p class="text-sm text-yellow-700">${selectedMessage.escalationReason}</p>
                        </div>
                    ` : ''}

                    ${selectedMessage.spamIndicators && selectedMessage.spamIndicators.length > 0 ? `
                        <div class="bg-red-50 border border-red-200 rounded-lg p-3">
                            <h4 class="font-medium text-red-800 mb-2 flex items-center">
                                <i data-lucide="shield" class="w-4 h-4 mr-1"></i>
                                Indicateurs de spam d√©tect√©s
                            </h4>
                            <ul class="text-sm text-red-700 space-y-1">
                                ${selectedMessage.spamIndicators.map(indicator => `<li>‚Ä¢ ${indicator}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}

                    ${!selectedMessage.archived && selectedMessage.status !== 'spam' ? `
                        <div class="flex flex-col space-y-3">
                            <button
                                onclick="sendResponse()"
                                class="w-full hormur-gradient text-white px-4 py-3 rounded-lg font-medium hover:opacity-90 transition-opacity flex items-center justify-center space-x-2"
                            >
                                <i data-lucide="send" class="w-4 h-4"></i>
                                <span>Envoyer la r√©ponse</span>
                            </button>
                            <div class="grid grid-cols-3 gap-2">
                                <button
                                    onclick="personalizeResponse()"
                                    class="px-3 py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 transition-colors flex items-center justify-center space-x-1 text-sm"
                                >
                                    <i data-lucide="user" class="w-4 h-4"></i>
                                    <span>Personnaliser</span>
                                </button>
                                <button
                                    onclick="regenerateResponse()"
                                    class="px-3 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors flex items-center justify-center space-x-1 text-sm"
                                >
                                    <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                                    <span>R√©g√©n√©rer</span>
                                </button>
                                <button
                                    onclick="archiveMessage(${selectedMessage.id})"
                                    class="px-3 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors flex items-center justify-center space-x-1 text-sm"
                                >
                                    <i data-lucide="archive" class="w-4 h-4"></i>
                                    <span>Archiver</span>
                                </button>
                            </div>
                        </div>
                    ` : selectedMessage.archived ? `
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
                            <i data-lucide="archive" class="w-8 h-8 text-blue-500 mx-auto mb-2"></i>
                            <p class="text-blue-800 font-medium mb-3">Message archiv√©</p>
                            <button
                                onclick="unarchiveMessage(${selectedMessage.id})"
                                class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors"
                            >
                                <i data-lucide="archive-restore" class="w-4 h-4 inline mr-1"></i>
                                Restaurer des archives
                            </button>
                        </div>
                    ` : `
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
                            <i data-lucide="shield" class="w-8 h-8 text-red-500 mx-auto mb-2"></i>
                            <p class="text-red-800 font-medium mb-3">Message marqu√© comme spam</p>
                            <div class="flex space-x-2 justify-center">
                                <button
                                    onclick="unmarkSpam(${selectedMessage.id})"
                                    class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
                                >
                                    <i data-lucide="shield-off" class="w-4 h-4 inline mr-1"></i>
                                    Marquer comme l√©gitime
                                </button>
                                <button
                                    onclick="archiveMessage(${selectedMessage.id})"
                                    class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors"
                                >
                                    <i data-lucide="archive" class="w-4 h-4 inline mr-1"></i>
                                    Archiver
                                </button>
                            </div>
                        </div>
                    `}
                </div>
            `;

            document.getElementById('message-modal').classList.remove('hidden');
            lucide.createIcons();
        }

        function closeMessageModal() {
            document.getElementById('message-modal').classList.add('hidden');
            selectedMessage = null;
        }

        function sendResponse() {
            if (!selectedMessage) return;
            
            const editedResponse = document.getElementById('ai-response-edit')?.value;
            if (editedResponse) {
                selectedMessage.aiResponse = editedResponse;
            }
            
            selectedMessage.status = 'sent';
            updateStats();
            closeMessageModal();
            renderCurrentTab();
            showToast('R√©ponse envoy√©e avec succ√®s !', 'success');
        }

        function personalizeResponse() {
            if (!selectedMessage || !currentUser) return;
            
            const currentResponse = document.getElementById('ai-response-edit')?.value || selectedMessage.aiResponse;
            const personalizedResponse = currentResponse + '\n\n' + currentUser.signature;
            
            document.getElementById('ai-response-edit').value = personalizedResponse;
            showToast('R√©ponse personnalis√©e avec votre signature', 'info');
        }

        function regenerateResponse() {
            if (!selectedMessage) return;
            
            showToast('R√©g√©n√©ration de la r√©ponse IA...', 'info');
            // Simulate AI regeneration
            setTimeout(() => {
                const responses = [
                    'Nouvelle r√©ponse g√©n√©r√©e par l\'IA Hormur avec am√©lioration de la personnalisation...',
                    'R√©ponse am√©lior√©e bas√©e sur l\'apprentissage continu de l\'IA...',
                    'Version optimis√©e de la r√©ponse avec meilleur ton Hormur...'
                ];
                const newResponse = responses[Math.floor(Math.random() * responses.length)];
                document.getElementById('ai-response-edit').value = newResponse;
                showToast('Nouvelle r√©ponse g√©n√©r√©e !', 'success');
            }, 2000);
        }

        function unmarkSpam(messageId) {
            const message = messages.find(m => m.id === messageId);
            if (message) {
                message.status = 'pending';
                message.spamScore = Math.max(message.spamScore - 30, 0);
                updateStats();
                closeMessageModal();
                renderCurrentTab();
                showToast('Message marqu√© comme l√©gitime', 'success');
            }
        }

        // Quick actions
        function showQuickActions() {
            document.getElementById('quick-actions-modal').classList.remove('hidden');
        }

        function closeQuickActions() {
            document.getElementById('quick-actions-modal').classList.add('hidden');
        }

        function refreshMessages() {
            showToast('Actualisation des messages...', 'info');
            // Simulate refresh
            setTimeout(() => {
                // Perform auto-archive
                archiveManager.performAutoArchive();
                updateStats();
                renderCurrentTab();
                showToast('Messages actualis√©s !', 'success');
            }, 1500);
        }

        function showSettings() {
            showToast('Param√®tres en d√©veloppement', 'info');
        }

        // Statistics update
        function updateStats() {
            const stats = {
                total: messages.length,
                auto: messages.filter(m => m.status === 'auto-sent').length,
                review: messages.filter(m => m.status === 'manual-review').length,
                urgent: messages.filter(m => 
                    m.priority === 'high' || 
                    (m.status === 'auto-sent' && (new Date().getTime() - (m.autoSentAt || m.timeReceived)) < 1800000)
                ).length,
                pending: messages.filter(m => m.status === 'pending').length,
                archived: archivedMessages.length
            };

            // Update header stats
            document.getElementById('total-count').textContent = `${stats.total} messages`;
            document.getElementById('auto-count').textContent = stats.auto;
            document.getElementById('review-count').textContent = stats.review;
            document.getElementById('urgent-count').textContent = stats.urgent;
            document.getElementById('pending-count').textContent = stats.pending;
            document.getElementById('archived-count').textContent = stats.archived;

            // Update tab badges
            document.getElementById('dashboard-badge').textContent = stats.urgent;
            document.getElementById('auto-badge').textContent = stats.auto;
            document.getElementById('validation-badge').textContent = stats.review;
            document.getElementById('archive-badge').textContent = stats.archived;

            // Update specific stats
            document.getElementById('today-auto').textContent = stats.auto;
            document.getElementById('ai-accuracy').textContent = '94%';
        }

        // Toast notifications
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            const icon = type === 'success' ? 'check' : type === 'error' ? 'alert-circle' : 'info';
            
            toast.className = `${bgColor} text-white px-4 py-3 rounded-lg shadow-lg fade-in flex items-center space-x-2`;
            toast.innerHTML = `
                <i data-lucide="${icon}" class="w-4 h-4"></i>
                <span class="text-sm">${message}</span>
            `;
            
            document.getElementById('toast-container').appendChild(toast);
            lucide.createIcons();
            
            setTimeout(() => {
                toast.remove();
            }, 4000);
        }

        // Event listeners
        document.getElementById('login-form').addEventListener('submit', handleLogin);

        // Add search functionality
        document.getElementById('search-input')?.addEventListener('input', () => {
            if (currentTab === 'all') {
                renderAllMessages();
            }
        });

        // Add filter functionality
        document.getElementById('status-filter')?.addEventListener('change', () => {
            if (currentTab === 'all') {
                renderAllMessages();
            }
        });

        document.getElementById('category-filter')?.addEventListener('change', () => {
            if (currentTab === 'all') {
                renderAllMessages();
            }
        });

        // Archive filters
        document.getElementById('archive-period-filter')?.addEventListener('change', () => {
            if (currentTab === 'archives') {
                renderArchivedMessages();
            }
        });

        document.getElementById('archive-category-filter')?.addEventListener('change', () => {
            if (currentTab === 'archives') {
                renderArchivedMessages();
            }
        });

        // Auto-archive settings
        document.getElementById('auto-archive-enabled')?.addEventListener('change', (e) => {
            archiveManager.autoArchiveEnabled = e.target.checked;
            archiveManager.saveToLocalStorage();
        });

        document.getElementById('auto-archive-delay')?.addEventListener('change', (e) => {
            archiveManager.autoArchiveDelay = parseInt(e.target.value);
            archiveManager.saveToLocalStorage();
        });

        // Simulate new messages with enhanced realism
        function simulateNewMessage() {
            if (!currentUser || Math.random() > 0.4) return;
            
            const templates = [
                {
                    from: `artiste.${Date.now()}@gmail.com`,
                    subject: 'Question sur les tarifs Hormur',
                    content: 'Bonjour, je suis musicien et j\'aimerais savoir comment fixer mes tarifs sur Hormur. Avez-vous des recommandations ?',
                    category: 'artiste',
                    priority: ['medium', 'low'][Math.floor(Math.random() * 2)],
                    status: Math.random() > 0.3 ? 'auto-sent' : 'manual-review'
                },
                {
                    from: `hote.curieux${Date.now()}@orange.fr`,
                    subject: 'Assurance pour mon lieu',
                    content: 'Bonjour, j\'ai un jardin de 100m¬≤ et j\'aimerais accueillir des concerts. L\'assurance Hormur couvre-t-elle les √©v√©nements en ext√©rieur ?',
                    category: 'hote',
                    priority: 'medium',
                    status: Math.random() > 0.5 ? 'auto-sent' : 'manual-review'
                },
                {
                    from: `spectateur${Date.now()}@yahoo.fr`,
                    subject: 'Annulation de derni√®re minute',
                    content: 'Bonjour, je ne peux malheureusement plus venir au concert de demain. Puis-je √™tre rembours√© ?',
                    category: 'spectateur',
                    priority: 'low',
                    status: Math.random() > 0.2 ? 'auto-sent' : 'pending'
                },
                {
                    from: `spam${Date.now()}@tempmail.co`,
                    subject: 'F√âLICITATIONS ! Vous avez gagn√© !',
                    content: 'Cliquez ici pour r√©clamer votre prix de 1000‚Ç¨ ! Offre limit√©e !',
                    category: 'spam',
                    priority: 'low',
                    status: 'spam'
                }
            ];
            
            const template = templates[Math.floor(Math.random() * templates.length)];
            const newMessage = {
                id: Date.now(),
                ...template,
                receivedAt: new Date().toISOString().slice(0, 16).replace('T', ' '),
                aiResponse: template.status === 'auto-sent' ? generateAIResponse(template.category, template.content) : null,
                confidence: template.status === 'auto-sent' ? Math.floor(Math.random() * 20) + 80 : Math.floor(Math.random() * 30) + 60,
                timeReceived: new Date().getTime(),
                autoSentAt: template.status === 'auto-sent' ? new Date().getTime() : null,
                spamScore: template.status === 'spam' ? Math.floor(Math.random() * 30) + 70 : Math.floor(Math.random() * 20) + 5,
                spamIndicators: template.status === 'spam' ? ['Urgence artificielle', 'Promesse d\'argent', 'Domaine temporaire'] : [],
                archived: false
            };
            
            messages.unshift(newMessage);
            updateStats();
            renderCurrentTab();
            showToast('Nouveau message re√ßu !', 'info');

            // Auto-archive if needed
            if (messages.length > archiveManager.maxActiveMessages) {
                setTimeout(() => {
                    archiveManager.performAutoArchive();
                    updateStats();
                    renderCurrentTab();
                }, 2000);
            }
        }

        function generateAIResponse(category, content) {
            const responses = {
                artiste: 'Bonjour !\n\nExcellente question ! Pour les tarifs, nous recommandons de commencer entre 15-25‚Ç¨ selon votre exp√©rience. Vous pouvez aussi proposer prix libre pour d√©buter.\n\nCr√©ez votre projet : https://hormur.com/projet/new\n\n√âl√©onore\nResponsable Relations Artistes\nHormur',
                hote: 'Bonjour !\n\nParfait ! Les jardins sont tr√®s appr√©ci√©s sur Hormur. Notre assurance Beloy x Hiscox couvre effectivement les √©v√©nements ext√©rieurs jusqu\'√† 1M‚Ç¨.\n\nPlus d\'infos : https://webviews.beloy.com/hormur/hormur.html\n\nMartin\nResponsable Partenariats Lieux\nHormur',
                spectateur: 'Bonjour,\n\nJe comprends votre situation. Selon nos CGU, les billets ne sont pas remboursables sauf annulation par l\'organisateur.\n\nVous pouvez cependant c√©der vos billets √† un proche.\n\nCordialement,\nL\'√©quipe Hormur'
            };
            return responses[category] || 'Bonjour,\n\nMerci pour votre message. Notre √©quipe va traiter votre demande rapidement.\n\nCordialement,\nL\'√©quipe Hormur';
        }

        // Initialize app
        function init() {
            if (!currentUser) return;
            
            // Load saved data
            archiveManager.loadFromLocalStorage();
            
            updateStats();
            renderCurrentTab();
            lucide.createIcons();
            
            // Perform initial auto-archive
            setTimeout(() => {
                archiveManager.performAutoArchive();
                updateStats();
                renderCurrentTab();
            }, 1000);
            
            // Simulate new messages
            setInterval(simulateNewMessage, 45000); // Every 45 seconds

            // Auto-archive check every hour
            setInterval(() => {
                if (archiveManager.autoArchiveEnabled) {
                    const archivedCount = archiveManager.performAutoArchive();
                    if (archivedCount > 0) {
                        updateStats();
                        renderCurrentTab();
                    }
                }
            }, 3600000); // Every hour
        }

        // Start app
        document.addEventListener('DOMContentLoaded', () => {
            initAuth();
            lucide.createIcons();
        });

        // Handle back button for modals
        window.addEventListener('popstate', (event) => {
            if (!document.getElementById('message-modal').classList.contains('hidden')) {
                closeMessageModal();
            }
            if (!document.getElementById('quick-actions-modal').classList.contains('hidden')) {
                closeQuickActions();
            }
            if (!document.getElementById('archive-manager-modal').classList.contains('hidden')) {
                closeArchiveManager();
            }
        });

        // Handle page visibility for auto-archive
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && archiveManager.autoArchiveEnabled) {
                // Check for auto-archive when page becomes visible
                setTimeout(() => {
                    const archivedCount = archiveManager.performAutoArchive();
                    if (archivedCount > 0) {
                        updateStats();
                        renderCurrentTab();
                    }
                }, 1000);
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // √âchap pour fermer les modals
            if (e.key === 'Escape') {
                if (!document.getElementById('message-modal').classList.contains('hidden')) {
                    closeMessageModal();
                }
                if (!document.getElementById('quick-actions-modal').classList.contains('hidden')) {
                    closeQuickActions();
                }
                if (!document.getElementById('archive-manager-modal').classList.contains('hidden')) {
                    closeArchiveManager();
                }
            }
            
            // Raccourcis pour navigation (Ctrl + nombre)
            if (e.ctrlKey && !e.shiftKey && !e.altKey) {
                switch(e.key) {
                    case '1':
                        e.preventDefault();
                        switchTab('dashboard');
                        break;
                    case '2':
                        e.preventDefault();
                        switchTab('auto-send');
                        break;
                    case '3':
                        e.preventDefault();
                        switchTab('validation');
                        break;
                    case '4':
                        e.preventDefault();
                        switchTab('archives');
                        break;
                    case '5':
                        e.preventDefault();
                        switchTab('all');
                        break;
                    case 'r':
                        e.preventDefault();
                        refreshMessages();
                        break;
                }
            }
        });

        // Window resize handler for responsive adjustments
        window.addEventListener('resize', () => {
            // Force re-render of current tab to adjust layout
            setTimeout(() => {
                renderCurrentTab();
            }, 100);
        });

    </script>
</body>
</html>
