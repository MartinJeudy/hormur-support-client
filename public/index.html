<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hormur - Support Client IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .line-clamp-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide-in-right {
            animation: slideInRight 0.3s ease-out;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        
        .pulse-urgent {
            animation: pulseUrgent 2s infinite;
        }
        
        @keyframes pulseUrgent {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
        }
        
        .auto-send-indicator {
            background: linear-gradient(45deg, #10b981, #059669);
            animation: pulse 2s infinite;
        }
        
        .urgent-indicator {
            background: linear-gradient(45deg, #ef4444, #dc2626);
            animation: bounce 1s infinite;
        }
        
        .hormur-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .tab-active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .tab-inactive {
            background: #f3f4f6;
            color: #6b7280;
        }
        
        .message-card {
            transition: all 0.2s ease;
            transform: translateZ(0);
        }
        
        .message-card:active {
            transform: scale(0.98);
        }
        
        .bottom-nav {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }
        
        .modal-overlay {
            backdrop-filter: blur(6px);
            background: rgba(0, 0, 0, 0.5);
        }
        
        .priority-high {
            border-left: 4px solid #ef4444;
            background: linear-gradient(90deg, #fef2f2 0%, #ffffff 30%);
        }
        
        .priority-medium {
            border-left: 4px solid #f59e0b;
            background: linear-gradient(90deg, #fef3c7 0%, #ffffff 30%);
        }
        
        .priority-low {
            border-left: 4px solid #10b981;
        }
        
        .auto-send-badge {
            background: linear-gradient(45deg, #10b981, #059669);
            color: white;
            animation: pulse 2s infinite;
        }
        
        .archived-badge {
            background: linear-gradient(45deg, #6b7280, #4b5563);
            color: white;
        }
        
        .custom-scrollbar {
            scrollbar-width: thin;
            scrollbar-color: #d1d5db #f3f4f6;
        }
        
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f3f4f6;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 2px;
        }
        
        @media (max-width: 768px) {
            .mobile-only { display: block; }
            .desktop-only { display: none; }
        }
        
        @media (min-width: 769px) {
            .mobile-only { display: none; }
            .desktop-only { display: block; }
        }

        .archive-transition {
            transition: all 0.3s ease;
        }

        .archive-transition.archived {
            opacity: 0.6;
            transform: scale(0.95);
        }

        .loading-spinner {
            border: 2px solid #f3f4f6;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
    <!-- Login Overlay -->
    <div id="login-overlay" class="fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4">
        <div class="hormur-gradient p-6 sm:p-8 rounded-2xl shadow-2xl max-w-md w-full text-white">
            <div class="text-center mb-6">
                <div class="w-16 h-16 mx-auto mb-4 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                    <i data-lucide="bot" class="w-8 h-8 text-white"></i>
                </div>
                <h2 class="text-2xl font-bold">Hormur IA Assistant</h2>
                <p class="text-indigo-100 mt-2 text-sm">Support Client Automatis√©</p>
            </div>
            
            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-indigo-100 mb-2">Email professionnel</label>
                    <input 
                        type="email" 
                        id="login-email"
                        required
                        class="w-full px-4 py-3 bg-white bg-opacity-20 border border-white border-opacity-30 rounded-lg text-white placeholder-indigo-200"
                        placeholder="votre.email@hormur.com"
                    />
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-indigo-100 mb-2">Mot de passe</label>
                    <input 
                        type="password" 
                        id="login-password"
                        required
                        class="w-full px-4 py-3 bg-white bg-opacity-20 border border-white border-opacity-30 rounded-lg text-white placeholder-indigo-200"
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                    />
                </div>
                
                <div id="login-error" class="hidden bg-red-500 bg-opacity-20 border border-red-300 text-red-100 px-4 py-3 rounded-lg text-sm">
                    Email ou mot de passe incorrect
                </div>
                
                <button 
                    type="submit"
                    id="login-button"
                    class="w-full bg-white text-indigo-600 py-3 px-4 rounded-lg hover:bg-indigo-50 transition-colors font-semibold flex items-center justify-center"
                >
                    <span id="login-text">Se connecter</span>
                    <div id="login-spinner" class="loading-spinner ml-2 hidden"></div>
                </button>
            </form>
            
            <div class="mt-6 text-center text-xs text-indigo-200">
                <p class="mb-2">√âquipe Hormur :</p>
                <div class="space-y-1">
                    <p>üé® El√©onore - Relations Artistes</p>
                    <p>üè° Martin - Partenariats Lieux</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="main-app" class="hidden">
        <!-- Mobile Header -->
        <header class="bg-white shadow-sm border-b sticky top-0 z-40">
            <div class="px-4 py-3">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <i data-lucide="bot" class="w-6 h-6 text-indigo-600"></i>
                        <div>
                            <h1 class="text-lg font-bold text-gray-900">Hormur IA</h1>
                            <div class="flex items-center space-x-2">
                                <div id="ai-status" class="flex items-center space-x-1">
                                    <div class="w-2 h-2 bg-green-500 rounded-full auto-send-indicator"></div>
                                    <span class="text-xs text-gray-600">IA Active</span>
                                </div>
                                <span id="total-count" class="text-xs text-gray-500">Chargement...</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button onclick="showQuickActions()" class="p-2 text-gray-400 hover:text-gray-600">
                            <i data-lucide="zap" class="w-5 h-5"></i>
                        </button>
                        <div id="user-avatar" class="w-8 h-8 hormur-gradient rounded-full flex items-center justify-center">
                            <span id="user-initials" class="text-white text-sm font-medium"></span>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Stats Bar -->
                <div class="mt-3 grid grid-cols-5 gap-2 text-center">
                    <div class="bg-green-50 p-2 rounded-lg">
                        <div class="text-sm font-bold text-green-700" id="auto-count">-</div>
                        <div class="text-xs text-green-600">Auto</div>
                    </div>
                    <div class="bg-orange-50 p-2 rounded-lg">
                        <div class="text-sm font-bold text-orange-700" id="review-count">-</div>
                        <div class="text-xs text-orange-600">√Ä valider</div>
                    </div>
                    <div class="bg-red-50 p-2 rounded-lg">
                        <div class="text-sm font-bold text-red-700" id="urgent-count">-</div>
                        <div class="text-xs text-red-600">Urgent</div>
                    </div>
                    <div class="bg-gray-50 p-2 rounded-lg">
                        <div class="text-sm font-bold text-gray-700" id="pending-count">-</div>
                        <div class="text-xs text-gray-600">En attente</div>
                    </div>
                    <div class="bg-blue-50 p-2 rounded-lg">
                        <div class="text-sm font-bold text-blue-700" id="archived-count">-</div>
                        <div class="text-xs text-blue-600">Archiv√©es</div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Tab Navigation -->
        <div class="bg-white border-b sticky top-[140px] z-30">
            <div class="flex overflow-x-auto custom-scrollbar">
                <button onclick="switchTab('dashboard')" id="tab-dashboard" class="tab-active px-4 py-3 text-sm font-medium whitespace-nowrap flex-shrink-0 flex items-center space-x-2">
                    <i data-lucide="layout-dashboard" class="w-4 h-4"></i>
                    <span>Dashboard</span>
                    <span id="dashboard-badge" class="bg-white bg-opacity-20 text-xs px-2 py-1 rounded-full">-</span>
                </button>
                <button onclick="switchTab('auto-send')" id="tab-auto-send" class="tab-inactive px-4 py-3 text-sm font-medium whitespace-nowrap flex-shrink-0 flex items-center space-x-2">
                    <i data-lucide="zap" class="w-4 h-4"></i>
                    <span>Auto-Send</span>
                    <span id="auto-badge" class="bg-green-600 text-white text-xs px-2 py-1 rounded-full">-</span>
                </button>
                <button onclick="switchTab('validation')" id="tab-validation" class="tab-inactive px-4 py-3 text-sm font-medium whitespace-nowrap flex-shrink-0 flex items-center space-x-2">
                    <i data-lucide="eye" class="w-4 h-4"></i>
                    <span>√Ä Valider</span>
                    <span id="validation-badge" class="bg-orange-600 text-white text-xs px-2 py-1 rounded-full">-</span>
                </button>
                <button onclick="switchTab('archives')" id="tab-archives" class="tab-inactive px-4 py-3 text-sm font-medium whitespace-nowrap flex-shrink-0 flex items-center space-x-2">
                    <i data-lucide="archive" class="w-4 h-4"></i>
                    <span>Archives</span>
                    <span id="archive-badge" class="bg-blue-600 text-white text-xs px-2 py-1 rounded-full">-</span>
                </button>
                <button onclick="switchTab('all')" id="tab-all" class="tab-inactive px-4 py-3 text-sm font-medium whitespace-nowrap flex-shrink-0 flex items-center space-x-2">
                    <i data-lucide="list" class="w-4 h-4"></i>
                    <span>Tous</span>
                </button>
            </div>
        </div>

        <!-- Content Container -->
        <div class="pb-20">
            <!-- Dashboard Tab -->
            <div id="content-dashboard" class="p-4 space-y-4">
                <!-- Urgent Actions Card -->
                <div id="urgent-actions" class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <h3 class="font-medium text-red-800 mb-3 flex items-center">
                        <i data-lucide="alert-triangle" class="w-5 h-5 mr-2"></i>
                        Actions Urgentes
                        <span class="ml-2 bg-red-600 text-white text-xs px-2 py-1 rounded-full" id="urgent-actions-count">-</span>
                    </h3>
                    <div id="urgent-messages" class="space-y-2">
                        <div class="text-center py-4 text-gray-500">
                            <div class="loading-spinner mx-auto mb-2"></div>
                            <p class="text-sm">Chargement des messages urgents...</p>
                        </div>
                    </div>
                </div>

                <!-- Auto-Send Surveillance -->
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <h3 class="font-medium text-green-800 mb-3 flex items-center">
                        <i data-lucide="bot" class="w-5 h-5 mr-2"></i>
                        Surveillance Auto-Send (aujourd'hui)
                        <span class="ml-2 bg-green-600 text-white text-xs px-2 py-1 rounded-full" id="surveillance-count">-</span>
                    </h3>
                    <div id="surveillance-auto-send" class="space-y-2">
                        <div class="text-center py-4 text-gray-500">
                            <div class="loading-spinner mx-auto mb-2"></div>
                            <p class="text-sm">Chargement de la surveillance...</p>
                        </div>
                    </div>
                </div>

                <!-- Quick Stats for Today -->
                <div class="bg-white rounded-lg p-4 border">
                    <h3 class="font-medium text-gray-900 mb-3 flex items-center">
                        <i data-lucide="trending-up" class="w-5 h-5 mr-2"></i>
                        Statistiques du jour
                    </h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-600" id="today-auto">-</div>
                            <div class="text-sm text-gray-600">Auto-envoy√©s</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-purple-600" id="ai-accuracy">-%</div>
                            <div class="text-sm text-gray-600">Pr√©cision IA</div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="refreshMessages()" class="bg-white p-4 rounded-lg shadow-sm border flex items-center space-x-3 hover:bg-gray-50">
                        <i data-lucide="refresh-cw" class="w-6 h-6 text-blue-600"></i>
                        <div class="text-left">
                            <div class="font-medium text-gray-900">Actualiser</div>
                            <div class="text-sm text-gray-500">Nouveaux messages</div>
                        </div>
                    </button>
                    <button onclick="showArchiveManager()" class="bg-white p-4 rounded-lg shadow-sm border flex items-center space-x-3 hover:bg-gray-50">
                        <i data-lucide="archive" class="w-6 h-6 text-indigo-600"></i>
                        <div class="text-left">
                            <div class="font-medium text-gray-900">Archivage</div>
                            <div class="text-sm text-gray-500">G√©rer les archives</div>
                        </div>
                    </button>
                </div>
            </div>

            <!-- Auto-Send Tab -->
            <div id="content-auto-send" class="hidden p-4">
                <div class="mb-4 bg-green-50 border border-green-200 rounded-lg p-3">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-medium text-green-800">Surveillance Auto-Send Active</h3>
                            <p class="text-sm text-green-600">Messages envoy√©s automatiquement par l'IA</p>
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-bold text-green-700" id="auto-send-today">-</div>
                            <div class="text-xs text-green-600">Aujourd'hui</div>
                        </div>
                    </div>
                </div>
                <div id="auto-send-messages" class="space-y-3">
                    <div class="text-center py-8 text-gray-500">
                        <div class="loading-spinner mx-auto mb-4"></div>
                        <p class="text-sm">Chargement des messages auto-envoy√©s...</p>
                    </div>
                </div>
            </div>

            <!-- Validation Tab -->
            <div id="content-validation" class="hidden p-4">
                <div class="mb-4 bg-orange-50 border border-orange-200 rounded-lg p-3">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-medium text-orange-800">Messages √† Valider</h3>
                            <p class="text-sm text-orange-600">N√©cessitent une intervention humaine</p>
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-bold text-orange-700" id="validation-today">-</div>
                            <div class="text-xs text-orange-600">En attente</div>
                        </div>
                    </div>
                </div>
                <div id="validation-messages" class="space-y-3">
                    <div class="text-center py-8 text-gray-500">
                        <div class="loading-spinner mx-auto mb-4"></div>
                        <p class="text-sm">Chargement des messages √† valider...</p>
                    </div>
                </div>
            </div>

            <!-- Archives Tab -->
            <div id="content-archives" class="hidden p-4">
                <div class="mb-4 bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-medium text-blue-800">Archives</h3>
                            <p class="text-sm text-blue-600">Conversations termin√©es et archiv√©es</p>
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-bold text-blue-700" id="total-archived">-</div>
                            <div class="text-xs text-blue-600">Total archiv√©es</div>
                        </div>
                    </div>
                </div>
                <div id="archived-messages" class="space-y-3">
                    <div class="text-center py-8 text-gray-500">
                        <div class="loading-spinner mx-auto mb-4"></div>
                        <p class="text-sm">Chargement des archives...</p>
                    </div>
                </div>
            </div>

            <!-- All Messages Tab -->
            <div id="content-all" class="hidden p-4">
                <!-- Search Bar -->
                <div class="mb-4">
                    <div class="relative">
                        <i data-lucide="search" class="absolute left-3 top-3 w-4 h-4 text-gray-400"></i>
                        <input
                            type="text"
                            id="search-input"
                            placeholder="Rechercher..."
                            class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                        />
                    </div>
                </div>

                <!-- Filters -->
                <div class="mb-4 flex space-x-2 overflow-x-auto custom-scrollbar">
                    <select id="status-filter" class="flex-shrink-0 px-3 py-2 border border-gray-300 rounded-lg text-sm">
                        <option value="all">Tous statuts</option>
                        <option value="auto-sent">Auto-envoy√©s</option>
                        <option value="manual-review">√Ä valider</option>
                        <option value="pending">En attente</option>
                        <option value="spam">Spam</option>
                        <option value="archived">Archiv√©s</option>
                    </select>
                    <select id="category-filter" class="flex-shrink-0 px-3 py-2 border border-gray-300 rounded-lg text-sm">
                        <option value="all">Toutes cat√©gories</option>
                        <option value="artiste">Artistes</option>
                        <option value="hote">H√¥tes</option>
                        <option value="spectateur">Spectateurs</option>
                        <option value="partenariat">Partenariats</option>
                    </select>
                </div>

                <div id="all-messages" class="space-y-3">
                    <div class="text-center py-8 text-gray-500">
                        <div class="loading-spinner mx-auto mb-4"></div>
                        <p class="text-sm">Chargement de tous les messages...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Message Detail Modal -->
        <div id="message-modal" class="fixed inset-0 modal-overlay z-50 hidden">
            <div class="min-h-screen px-2 sm:px-4 flex items-end sm:items-center justify-center">
                <div class="bg-white rounded-t-2xl sm:rounded-2xl shadow-xl w-full max-w-2xl h-[95vh] sm:max-h-[90vh] overflow-hidden slide-in-right flex flex-col">
                    <div class="sticky top-0 bg-white border-b px-4 py-3 flex items-center justify-between flex-shrink-0">
                        <h3 class="font-semibold text-gray-900 flex items-center">
                            <i data-lucide="message-circle" class="w-5 h-5 mr-2"></i>
                            D√©tails du message
                        </h3>
                        <div class="flex items-center space-x-2">
                            <button onclick="archiveMessage(selectedMessage?.id)" class="text-blue-600 hover:text-blue-800" title="Archiver">
                                <i data-lucide="archive" class="w-5 h-5"></i>
                            </button>
                            <button onclick="closeMessageModal()" class="text-gray-400 hover:text-gray-600">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                    </div>
                    <div id="message-detail-content" class="p-4 overflow-y-auto custom-scrollbar flex-1">
                        <!-- Message details will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions Modal -->
        <div id="quick-actions-modal" class="fixed inset-0 modal-overlay z-50 hidden">
            <div class="min-h-screen px-4 flex items-end justify-center">
                <div class="bg-white rounded-t-2xl shadow-xl w-full max-w-sm mb-0 slide-in-right">
                    <div class="p-4">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-semibold text-gray-900">Actions Rapides</h3>
                            <button onclick="closeQuickActions()" class="text-gray-400">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                        <div class="space-y-3">
                            <button onclick="refreshMessages(); closeQuickActions();" class="w-full p-3 bg-blue-50 text-blue-700 rounded-lg flex items-center space-x-3">
                                <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                                <span>Actualiser les messages</span>
                            </button>
                            <button onclick="logout(); closeQuickActions();" class="w-full p-3 bg-red-50 text-red-700 rounded-lg flex items-center space-x-3">
                                <i data-lucide="log-out" class="w-5 h-5"></i>
                                <span>D√©connexion</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Toast -->
        <div id="toast-container" class="fixed bottom-4 left-4 right-4 z-50 space-y-2"></div>
    </div>

    <script>
        // Configuration utilisateurs Hormur
        const AUTHORIZED_USERS = {
            'eleonore@hormur.com': {
                password: 'Hormur2025!',
                name: 'El√©onore',
                role: 'Responsable Relations Artistes',
                signature: `Cordialement,\n\nEl√©onore\nResponsable Relations Artistes\nHormur - Cr√©ons ensemble des moments uniques\n\nüìß eleonore@hormur.com\nüåê www.hormur.com\nüé≠ "L'art se vit partout, cr√©ons l'inattendu"`,
                specialties: ['artistes', '√©v√©nements', 'cr√©ativit√©'],
                color: '#e11d48',
                brevoAgentId: '6223aae91d1bcc698a514cd6_67d814247e4a70279409c965'
            },
            'martin.jeudy@hormur.com': {
                password: 'Hormur2025!',
                name: 'Martin',
                role: 'Responsable Partenariats Lieux',
                signature: `Bien √† vous,\n\nMartin\nResponsable Partenariats Lieux\nHormur - Transformons vos espaces en sc√®nes\n\nüìß martin.jeudy@hormur.com\nüåê www.hormur.com\nüè° "Votre lieu a une histoire, donnons-lui une sc√®ne"`,
                specialties: ['lieux', 'h√¥tes', 'logistique', 'partenariats'],
                color: '#059669',
                brevoAgentId: '6223aae91d1bcc698a514cd6_67a0bf5edbc8f653740f31c8'
            }
        };

        // Variables globales
        let currentTab = 'dashboard';
        let selectedMessage = null;
        let currentUser = null;
        let allMessages = [];
        let isLoading = false;

        // Configuration API
        const API_CONFIG = {
            baseUrl: '', // Netlify functions are at the same domain
            endpoints: {
                getMessages: '/.netlify/functions/get_messages_datastore',
                sendResponse: '/.netlify/functions/send_response_datastore',
                sendBrevoResponse: '/.netlify/functions/send_brevo_direct', // Nouvelle fonction
                updateMessage: '/.netlify/functions/update_datastore'
            }
        };

        // Utility functions
        function timeAgo(timestamp) {
            const now = new Date().getTime();
            const diff = now - timestamp;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return '√Ä l\'instant';
            if (minutes < 60) return `${minutes}min`;
            if (hours < 24) return `${hours}h`;
            if (days < 30) return `${days}j`;
            return `${Math.floor(days / 30)}mois`;
        }

        function getCategoryColor(category) {
            const colors = {
                artiste: 'bg-purple-100 text-purple-800',
                hote: 'bg-green-100 text-green-800',
                spectateur: 'bg-blue-100 text-blue-800',
                paiement: 'bg-red-100 text-red-800',
                partenariat: 'bg-teal-100 text-teal-800',
                spam: 'bg-red-200 text-red-900'
            };
            return colors[category] || 'bg-gray-100 text-gray-800';
        }

        function getCategoryIcon(category) {
            const icons = {
                artiste: 'palette',
                hote: 'home',
                spectateur: 'users',
                paiement: 'credit-card',
                partenariat: 'handshake',
                spam: 'shield'
            };
            return icons[category] || 'message-circle';
        }

        function getPriorityColor(priority) {
            const colors = {
                high: 'text-red-600',
                medium: 'text-orange-600',
                low: 'text-green-600'
            };
            return colors[priority] || 'text-gray-600';
        }

        function getPriorityIcon(priority) {
            const icons = {
                high: 'alert-triangle',
                medium: 'minus-circle',
                low: 'check-circle'
            };
            return icons[priority] || 'circle';
        }

        // API Functions
        async function apiCall(endpoint, method = 'GET', data = null) {
            try {
                const options = {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                };

                if (data) {
                    options.body = JSON.stringify(data);
                }

                const response = await fetch(API_CONFIG.baseUrl + endpoint, options);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }

                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        async function loadMessages(filters = {}) {
            if (isLoading) return;
            
            try {
                isLoading = true;
                showLoadingInContainers();
                
                const result = await apiCall(API_CONFIG.endpoints.getMessages, 'POST', { filters });
                
                if (result.success) {
                    allMessages = result.messages || [];
                    updateStats();
                    renderCurrentTab();
                    showToast(`${allMessages.length} messages charg√©s`, 'success');
                } else {
                    throw new Error(result.error || 'Erreur lors du chargement');
                }
            } catch (error) {
                console.error('Erreur loadMessages:', error);
                showToast('Erreur lors du chargement: ' + error.message, 'error');
                showErrorInContainers(error.message);
            } finally {
                isLoading = false;
            }
        }

        async function archiveMessage(messageId) {
            if (!messageId) return;
            
            try {
                // Optimisation: mise √† jour locale imm√©diate pour l'UX
                const messageIndex = allMessages.findIndex(m => m.id == messageId);
                if (messageIndex !== -1) {
                    allMessages[messageIndex].archived = true;
                    allMessages[messageIndex].status = 'archived';
                    
                    // Mise √† jour imm√©diate de l'interface
                    updateStats();
                    renderCurrentTab();
                    
                    if (selectedMessage?.id == messageId) {
                        closeMessageModal();
                    }
                }
                
                showToast('Message archiv√© !', 'success');
                
                // Appel API en arri√®re-plan
                const result = await apiCall(API_CONFIG.endpoints.updateMessage, 'POST', {
                    action: 'archive',
                    message_id: messageId,
                    user_email: currentUser?.email
                });
                
                if (!result.success) {
                    // En cas d'erreur, restaurer l'√©tat
                    if (messageIndex !== -1) {
                        allMessages[messageIndex].archived = false;
                        allMessages[messageIndex].status = 'manual-review';
                        updateStats();
                        renderCurrentTab();
                    }
                    throw new Error(result.error || 'Erreur lors de l\'archivage');
                }
                
            } catch (error) {
                console.error('Erreur archivage:', error);
                showToast('Erreur lors de l\'archivage: ' + error.message, 'error');
            }
        }

        async function sendResponse(messageId, responseText, sentBy) {
            if (!messageId || !responseText || !sentBy) return;
            
            try {
                showToast('Envoi en cours...', 'info');
                
                // V√©rifier si on a un visitor_id pour l'envoi direct Brevo
                const message = allMessages.find(m => m.id === messageId);
                const hasVisitorId = message && message.visitorId;
                
                let result;
                
                if (hasVisitorId) {
                    // Utiliser l'envoi direct Brevo
                    console.log('üìß Envoi direct via Brevo');
                    result = await apiCall(API_CONFIG.endpoints.sendBrevoResponse, 'POST', {
                        message_id: messageId,
                        response_text: responseText,
                        sent_by: sentBy,
                        visitor_id: message.visitorId
                    });
                } else {
                    // Utiliser l'ancienne m√©thode via Make.com
                    console.log('üîÑ Envoi via Make.com (pas de visitor_id)');
                    result = await apiCall(API_CONFIG.endpoints.sendResponse, 'POST', {
                        message_id: messageId,
                        response_text: responseText,
                        sent_by: sentBy,
                        user_modifications: true
                    });
                }
                
                if (result.success) {
                    // Mettre √† jour localement
                    const messageIndex = allMessages.findIndex(m => m.id == messageId);
                    if (messageIndex !== -1) {
                        allMessages[messageIndex].status = 'sent';
                        allMessages[messageIndex].finalResponse = responseText;
                    }
                    
                    updateStats();
                    renderCurrentTab();
                    showToast('R√©ponse envoy√©e avec succ√®s !', 'success');
                    closeMessageModal();
                } else {
                    throw new Error(result.error || 'Erreur lors de l\'envoi');
                }
            } catch (error) {
                console.error('Erreur envoi:', error);
                showToast('Erreur lors de l\'envoi: ' + error.message, 'error');
            }
        }

        // Authentication
        function initAuth() {
            const loggedUser = localStorage.getItem('hormur_logged_user');
            if (loggedUser) {
                currentUser = JSON.parse(loggedUser);
                handleUserLogin(currentUser);
            } else {
                showLoginOverlay();
            }
        }

        async function handleLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('login-email').value.toLowerCase().trim();
            const password = document.getElementById('login-password').value;
            const errorDiv = document.getElementById('login-error');
            const loginButton = document.getElementById('login-button');
            const loginText = document.getElementById('login-text');
            const loginSpinner = document.getElementById('login-spinner');
            
            // Show loading
            loginButton.disabled = true;
            loginText.textContent = 'Connexion...';
            loginSpinner.classList.remove('hidden');
            
            // Simulate API delay
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            if (AUTHORIZED_USERS[email] && AUTHORIZED_USERS[email].password === password) {
                currentUser = { email, ...AUTHORIZED_USERS[email] };
                localStorage.setItem('hormur_logged_user', JSON.stringify(currentUser));
                handleUserLogin(currentUser);
                errorDiv.classList.add('hidden');
            } else {
                errorDiv.classList.remove('hidden');
                loginButton.disabled = false;
                loginText.textContent = 'Se connecter';
                loginSpinner.classList.add('hidden');
            }
        }

        function handleUserLogin(user) {
            document.getElementById('user-initials').textContent = user.name.split(' ').map(n => n[0]).join('');
            hideLoginOverlay();
            init();
            showToast(`Bienvenue ${user.name} !`, 'success');
        }

        function showLoginOverlay() {
            document.getElementById('login-overlay').classList.remove('hidden');
            document.getElementById('main-app').classList.add('hidden');
        }

        function hideLoginOverlay() {
            document.getElementById('login-overlay').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
        }

        function logout() {
            localStorage.removeItem('hormur_logged_user');
            currentUser = null;
            allMessages = [];
            showLoginOverlay();
            showToast('D√©connect√© avec succ√®s');
        }

        // Tab management
        function switchTab(tab) {
            currentTab = tab;
            
            // Update tab styling
            document.querySelectorAll('[id^="tab-"]').forEach(t => {
                t.className = t.className.replace('tab-active', 'tab-inactive');
            });
            document.getElementById(`tab-${tab}`).className = 
                document.getElementById(`tab-${tab}`).className.replace('tab-inactive', 'tab-active');
            
            // Update content
            document.querySelectorAll('[id^="content-"]').forEach(c => c.classList.add('hidden'));
            document.getElementById(`content-${tab}`).classList.remove('hidden');
            
            renderCurrentTab();
        }

        function renderCurrentTab() {
            switch(currentTab) {
                case 'dashboard':
                    renderDashboard();
                    break;
                case 'auto-send':
                    renderAutoSendMessages();
                    break;
                case 'validation':
                    renderValidationMessages();
                    break;
                case 'archives':
                    renderArchivedMessages();
                    break;
                case 'all':
                    renderAllMessages();
                    break;
            }
        }

        function renderDashboard() {
            renderUrgentMessages();
            renderSurveillanceAutoSend();
        }

        function renderUrgentMessages() {
            const urgentMessages = allMessages.filter(m => 
                m.priority === 'high' && 
                !m.archived && 
                m.status.toLowerCase() !== 'archived' &&
                m.status.toLowerCase() !== 'spam' &&
                m.status.toLowerCase() !== 'sent'
            ).sort((a, b) => b.timeReceived - a.timeReceived);

            const container = document.getElementById('urgent-messages');
            document.getElementById('urgent-actions-count').textContent = urgentMessages.length;

            if (urgentMessages.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4 text-green-600">
                        <i data-lucide="check-circle" class="w-8 h-8 mx-auto mb-2"></i>
                        <p class="text-sm">Aucune action urgente !</p>
                    </div>
                `;
            } else {
                container.innerHTML = urgentMessages.map(msg => `
                    <div class="message-card bg-white p-3 rounded-lg border border-red-200 ${msg.priority === 'high' ? 'pulse-urgent' : ''}" onclick="openMessageModal('${msg.id}')">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-1">
                                    <span class="text-sm font-medium text-gray-900">${msg.from}</span>
                                    <span class="px-2 py-1 text-xs rounded-full ${getCategoryColor(msg.category)}">
                                        ${msg.category}
                                    </span>
                                    <span class="urgent-indicator px-2 py-1 text-xs text-white rounded-full">URGENT</span>
                                </div>
                                <p class="text-sm text-gray-700 line-clamp-2">${msg.subject}</p>
                                <div class="flex items-center justify-between mt-2">
                                    <span class="text-xs text-gray-500">${msg.receivedAt}</span>
                                </div>
                            </div>
                            <div class="flex items-center space-x-1">
                                <button onclick="event.stopPropagation(); archiveMessage('${msg.id}')" class="text-blue-600 hover:text-blue-800" title="Archiver">
                                    <i data-lucide="archive" class="w-4 h-4"></i>
                                </button>
                                <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400"></i>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            lucide.createIcons();
        }

        function renderSurveillanceAutoSend() {
            const surveillanceMessages = allMessages.filter(m => {
                if (m.status.toLowerCase() !== 'auto-sent') return false;
                
                const messageDate = new Date(m.autoSentAt || m.timeReceived);
                const today = new Date();
                
                // V√©rifier si le message a √©t√© envoy√© aujourd'hui
                return messageDate.toDateString() === today.toDateString();
            }).sort((a, b) => (b.autoSentAt || b.timeReceived) - (a.autoSentAt || a.timeReceived));

            const container = document.getElementById('surveillance-auto-send');
            document.getElementById('surveillance-count').textContent = surveillanceMessages.length;

            if (surveillanceMessages.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4 text-gray-500">
                        <i data-lucide="clock" class="w-8 h-8 mx-auto mb-2"></i>
                        <p class="text-sm">Aucun auto-send r√©cent √† surveiller</p>
                    </div>
                `;
            } else {
                container.innerHTML = surveillanceMessages.map(msg => `
                    <div class="message-card bg-white p-3 rounded-lg border border-green-200" onclick="openMessageModal('${msg.id}')">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-1">
                                    <div class="auto-send-badge px-2 py-1 text-xs rounded-full">AUTO</div>
                                    <span class="text-sm font-medium text-gray-900">${msg.from}</span>
                                    <span class="text-xs text-green-600">${msg.confidence}%</span>
                                </div>
                                <p class="text-sm text-gray-700 line-clamp-2">${msg.subject}</p>
                                <div class="flex items-center justify-between mt-2">
                                    <span class="text-xs text-gray-500">Envoy√© ${timeAgo(msg.autoSentAt || msg.timeReceived)}</span>
                                </div>
                            </div>
                            <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400 ml-2"></i>
                        </div>
                    </div>
                `).join('');
            }
            lucide.createIcons();
        }

        function renderAutoSendMessages() {
            const autoSendMessages = allMessages.filter(m => 
                m.status.toLowerCase() === 'auto-sent'
            ).sort((a, b) => (b.autoSentAt || b.timeReceived) - (a.autoSentAt || a.timeReceived));

            const container = document.getElementById('auto-send-messages');
            document.getElementById('auto-send-today').textContent = autoSendMessages.length;

            if (autoSendMessages.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i data-lucide="zap" class="w-12 h-12 mx-auto mb-4 text-gray-300"></i>
                        <p>Aucun message auto-envoy√©</p>
                    </div>
                `;
            } else {
                container.innerHTML = autoSendMessages.map(msg => `
                    <div class="message-card bg-white p-4 rounded-lg shadow-sm border" onclick="openMessageModal('${msg.id}')">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-2">
                                    <div class="auto-send-badge px-2 py-1 text-xs rounded-full flex items-center space-x-1">
                                        <i data-lucide="zap" class="w-3 h-3"></i>
                                        <span>AUTO</span>
                                    </div>
                                    <span class="px-2 py-1 text-xs rounded-full ${getCategoryColor(msg.category)}">
                                        ${msg.category}
                                    </span>
                                    <span class="text-xs font-medium ${getPriorityColor(msg.priority)}">${msg.confidence}%</span>
                                </div>
                                <div class="mb-2">
                                    <h4 class="font-medium text-gray-900">${msg.from}</h4>
                                    <p class="text-sm text-gray-700">${msg.subject}</p>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-xs text-gray-500">Envoy√© ${timeAgo(msg.autoSentAt || msg.timeReceived)}</span>
                                </div>
                            </div>
                            <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400 ml-2"></i>
                        </div>
                    </div>
                `).join('');
            }
            lucide.createIcons();
        }

        function renderValidationMessages() {
            // Hi√©rarchisation claire des messages √† valider
            const validationMessages = allMessages.filter(m => 
                m.status.toLowerCase() === 'manual-review' || m.status.toLowerCase() === 'pending'
            ).sort((a, b) => {
                // Priorit√© 1: Urgents (high priority)
                if (a.priority === 'high' && b.priority !== 'high') return -1;
                if (b.priority === 'high' && a.priority !== 'high') return 1;
                
                // Priorit√© 2: Business opportunities
                if (a.category === 'partenariat' && b.category !== 'partenariat') return -1;
                if (b.category === 'partenariat' && a.category !== 'partenariat') return 1;
                
                // Priorit√© 3: Manual review avant pending
                if (a.status.toLowerCase() === 'manual-review' && b.status.toLowerCase() === 'pending') return -1;
                if (b.status.toLowerCase() === 'manual-review' && a.status.toLowerCase() === 'pending') return 1;
                
                // Priorit√© 4: Par ordre chronologique (plus r√©cent d'abord)
                return b.timeReceived - a.timeReceived;
            });

            const container = document.getElementById('validation-messages');
            document.getElementById('validation-today').textContent = validationMessages.length;

            if (validationMessages.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i data-lucide="eye" class="w-12 h-12 mx-auto mb-4 text-gray-300"></i>
                        <p>Aucun message √† valider</p>
                    </div>
                `;
            } else {
                container.innerHTML = validationMessages.map(msg => `
                    <div class="message-card bg-white p-4 rounded-lg shadow-sm border ${msg.priority === 'high' ? 'priority-high' : msg.priority === 'medium' ? 'priority-medium' : 'priority-low'}" onclick="openMessageModal('${msg.id}')">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-2">
                                    <span class="px-2 py-1 text-xs rounded-full ${getCategoryColor(msg.category)}">
                                        ${msg.category}
                                    </span>
                                    <span class="px-2 py-1 text-xs rounded-full ${
                                        msg.priority === 'high' ? 'bg-red-100 text-red-700' :
                                        msg.priority === 'medium' ? 'bg-orange-100 text-orange-700' :
                                        'bg-green-100 text-green-700'
                                    }">
                                        <i data-lucide="${getPriorityIcon(msg.priority)}" class="w-3 h-3 inline mr-1"></i>
                                        ${msg.priority === 'high' ? 'Urgent' : msg.priority === 'medium' ? 'Moyen' : 'Faible'}
                                    </span>
                                </div>
                                <div class="mb-2">
                                    <h4 class="font-medium text-gray-900">${msg.from}</h4>
                                    <p class="text-sm text-gray-700">${msg.subject}</p>
                                </div>
                                <p class="text-sm text-gray-600 line-clamp-3 mb-3">${msg.content}</p>
                            </div>
                            <div class="flex flex-col items-center space-y-2">
                                <button onclick="event.stopPropagation(); archiveMessage('${msg.id}')" class="text-blue-600 hover:text-blue-800" title="Archiver">
                                    <i data-lucide="archive" class="w-4 h-4"></i>
                                </button>
                                <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400"></i>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            lucide.createIcons();
        }

        function renderArchivedMessages() {
            const archivedMessages = allMessages.filter(m => 
                m.archived || m.status.toLowerCase() === 'archived'
            );

            const container = document.getElementById('archived-messages');
            document.getElementById('total-archived').textContent = archivedMessages.length;

            if (archivedMessages.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i data-lucide="archive" class="w-12 h-12 mx-auto mb-4 text-gray-300"></i>
                        <p>Aucune archive trouv√©e</p>
                    </div>
                `;
            } else {
                container.innerHTML = archivedMessages.map(msg => `
                    <div class="message-card bg-gray-50 p-4 rounded-lg border" onclick="openMessageModal('${msg.id}', true)">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-2">
                                    <span class="archived-badge px-2 py-1 text-xs rounded-full">ARCHIV√â</span>
                                    <span class="px-2 py-1 text-xs rounded-full ${getCategoryColor(msg.category)}">
                                        ${msg.category}
                                    </span>
                                </div>
                                <div class="mb-2">
                                    <h4 class="font-medium text-gray-700">${msg.from}</h4>
                                    <p class="text-sm text-gray-600">${msg.subject}</p>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-xs text-gray-500">Re√ßu: ${msg.receivedAt}</span>
                                </div>
                            </div>
                            <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400 ml-2"></i>
                        </div>
                    </div>
                `).join('');
            }
            lucide.createIcons();
        }

        function renderAllMessages() {
            const container = document.getElementById('all-messages');
            
            // Appliquer les filtres et recherche
            let filteredMessages = [...allMessages];
            
            // Filtre par statut
            const statusFilter = document.getElementById('status-filter')?.value;
            if (statusFilter && statusFilter !== 'all') {
                filteredMessages = filteredMessages.filter(m => 
                    m.status.toLowerCase() === statusFilter.toLowerCase()
                );
            }
            
            // Filtre par cat√©gorie
            const categoryFilter = document.getElementById('category-filter')?.value;
            if (categoryFilter && categoryFilter !== 'all') {
                filteredMessages = filteredMessages.filter(m => 
                    m.category.toLowerCase() === categoryFilter.toLowerCase()
                );
            }
            
            // Recherche textuelle
            const searchInput = document.getElementById('search-input')?.value;
            if (searchInput && searchInput.trim()) {
                const searchTerm = searchInput.toLowerCase();
                filteredMessages = filteredMessages.filter(m => 
                    m.from.toLowerCase().includes(searchTerm) ||
                    m.subject.toLowerCase().includes(searchTerm) ||
                    m.content.toLowerCase().includes(searchTerm)
                );
            }

            if (filteredMessages.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-4 text-gray-300"></i>
                        <p>Aucun message trouv√©</p>
                    </div>
                `;
            } else {
                container.innerHTML = filteredMessages.map(msg => `
                    <div class="message-card bg-white p-4 rounded-lg shadow-sm border" onclick="openMessageModal('${msg.id}')">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-2">
                                    <i data-lucide="${getCategoryIcon(msg.category)}" class="w-4 h-4 text-gray-500"></i>
                                    <span class="px-2 py-1 text-xs rounded-full ${getCategoryColor(msg.category)}">
                                        ${msg.category}
                                    </span>
                                    <span class="text-xs ${getPriorityColor(msg.priority)}">${msg.priority}</span>
                                    ${msg.status.toLowerCase() === 'auto-sent' ? '<div class="auto-send-badge px-2 py-1 text-xs rounded-full">AUTO</div>' : ''}
                                    ${msg.archived || msg.status.toLowerCase() === 'archived' ? '<div class="archived-badge px-2 py-1 text-xs rounded-full">ARCHIV√â</div>' : ''}
                                </div>
                                <div class="mb-2">
                                    <h4 class="font-medium text-gray-900">${msg.from}</h4>
                                    <p class="text-sm text-gray-700">${msg.subject}</p>
                                </div>
                                <p class="text-sm text-gray-600 line-clamp-2 mb-2">${msg.content}</p>
                                <div class="flex items-center justify-between">
                                    <span class="text-xs text-gray-500">${msg.receivedAt}</span>
                                    <span class="text-xs ${
                                        msg.status.toLowerCase() === 'auto-sent' ? 'text-green-600' :
                                        msg.status.toLowerCase() === 'manual-review' ? 'text-orange-600' :
                                        msg.status.toLowerCase() === 'spam' ? 'text-red-600' : 
                                        msg.status.toLowerCase() === 'pending' ? 'text-gray-600' : 'text-gray-600'
                                    }">
                                        ${msg.status.toLowerCase() === 'auto-sent' ? 'Auto-envoy√©' :
                                          msg.status.toLowerCase() === 'manual-review' ? '√Ä valider' :
                                          msg.status.toLowerCase() === 'spam' ? 'Spam' : 
                                          msg.status.toLowerCase() === 'sent' ? 'Envoy√©' :
                                          msg.status.toLowerCase() === 'pending' ? 'En attente' : 'En attente'}
                                    </span>
                                </div>
                            </div>
                            <div class="flex flex-col items-center space-y-2">
                                <button onclick="event.stopPropagation(); archiveMessage('${msg.id}')" class="text-blue-600 hover:text-blue-800" title="Archiver">
                                    <i data-lucide="archive" class="w-4 h-4"></i>
                                </button>
                                <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400"></i>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            lucide.createIcons();
        }

        // Message modal
        function openMessageModal(messageId, isArchived = false) {
            selectedMessage = allMessages.find(m => m.id == messageId);
            if (!selectedMessage) return;

            document.getElementById('message-detail-content').innerHTML = `
                <div class="space-y-4">
                    <div class="flex items-center space-x-2 flex-wrap">
                        <span class="px-3 py-1 text-sm rounded-full ${getCategoryColor(selectedMessage.category)}">
                            <i data-lucide="${getCategoryIcon(selectedMessage.category)}" class="w-4 h-4 inline mr-1"></i>
                            ${selectedMessage.category}
                        </span>
                        <span class="px-3 py-1 text-sm rounded-full ${
                            selectedMessage.priority === 'high' ? 'bg-red-100 text-red-700' :
                            selectedMessage.priority === 'medium' ? 'bg-orange-100 text-orange-700' :
                            'bg-green-100 text-green-700'
                        }">
                            <i data-lucide="${getPriorityIcon(selectedMessage.priority)}" class="w-4 h-4 inline mr-1"></i>
                            Priorit√© ${selectedMessage.priority === 'high' ? 'haute' : selectedMessage.priority === 'medium' ? 'moyenne' : 'basse'}
                        </span>
                        ${selectedMessage.status.toLowerCase() === 'auto-sent' ? `
                            <span class="auto-send-badge px-3 py-1 text-sm rounded-full">
                                <i data-lucide="zap" class="w-4 h-4 inline mr-1"></i>
                                Auto-envoy√©
                            </span>
                        ` : ''}
                    </div>

                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-medium text-gray-900 mb-2">Message original</h4>
                        <div class="space-y-2 text-sm">
                            <div><strong>De :</strong> ${selectedMessage.from}</div>
                            <div><strong>Sujet :</strong> ${selectedMessage.subject}</div>
                            <div><strong>Re√ßu :</strong> ${selectedMessage.receivedAt}</div>
                        </div>
                        <div class="mt-3">
                            <p class="text-sm text-gray-700 bg-white p-3 rounded border">${selectedMessage.content}</p>
                        </div>
                    </div>

                    ${selectedMessage.aiResponse ? `
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="font-medium text-blue-900 mb-2 flex items-center">
                                <i data-lucide="bot" class="w-4 h-4 mr-1"></i>
                                R√©ponse IA Hormur
                                ${selectedMessage.confidence ? `<span class="ml-2 text-sm">(${selectedMessage.confidence}% confiance)</span>` : ''}
                            </h4>
                            <div>
                                <textarea
                                    id="ai-response-edit"
                                    class="w-full p-3 border border-blue-200 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm"
                                    rows="8"
                                >${selectedMessage.aiResponse}</textarea>
                            </div>
                        </div>
                    ` : ''}

                    ${!selectedMessage.archived && 
                      selectedMessage.status.toLowerCase() !== 'spam' && 
                      selectedMessage.status.toLowerCase() !== 'sent' &&
                      selectedMessage.status.toLowerCase() !== 'archived' ? `
                        <div class="flex flex-col space-y-3">
                            <button
                                onclick="handleSendResponse()"
                                class="w-full hormur-gradient text-white px-4 py-3 rounded-lg font-medium hover:opacity-90 transition-opacity flex items-center justify-center space-x-2"
                            >
                                <i data-lucide="send" class="w-4 h-4"></i>
                                <span>Envoyer la r√©ponse</span>
                            </button>
                            <div class="grid grid-cols-2 gap-2">
                                <button
                                    onclick="personalizeResponse()"
                                    class="px-3 py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 transition-colors flex items-center justify-center space-x-1 text-sm"
                                >
                                    <i data-lucide="user" class="w-4 h-4"></i>
                                    <span>Personnaliser</span>
                                </button>
                                <button
                                    onclick="archiveMessage('${selectedMessage.id}')"
                                    class="px-3 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors flex items-center justify-center space-x-1 text-sm"
                                >
                                    <i data-lucide="archive" class="w-4 h-4"></i>
                                    <span>Archiver</span>
                                </button>
                            </div>
                        </div>
                    ` : `
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
                            <i data-lucide="archive" class="w-8 h-8 text-blue-500 mx-auto mb-2"></i>
                            <p class="text-blue-800 font-medium">Message trait√©</p>
                        </div>
                    `}
                </div>
            `;

            document.getElementById('message-modal').classList.remove('hidden');
            lucide.createIcons();
        }

        function closeMessageModal() {
            document.getElementById('message-modal').classList.add('hidden');
            selectedMessage = null;
        }

        function handleSendResponse() {
            if (!selectedMessage) return;
            
            const editedResponse = document.getElementById('ai-response-edit')?.value;
            if (editedResponse && currentUser?.email) {
                sendResponse(selectedMessage.id, editedResponse, currentUser.email);
            }
        }

        function personalizeResponse() {
            if (!selectedMessage || !currentUser) return;
            
            const currentResponse = document.getElementById('ai-response-edit')?.value || selectedMessage.aiResponse;
            
            // Permettre √† l'utilisateur de personnaliser sa signature
            const customSignature = prompt(
                'Voulez-vous utiliser votre signature par d√©faut ou la personnaliser ?\n\nSignature actuelle :', 
                currentUser.signature
            );
            
            if (customSignature !== null) {
                const personalizedResponse = currentResponse + '\n\n' + customSignature;
                document.getElementById('ai-response-edit').value = personalizedResponse;
                showToast('R√©ponse personnalis√©e avec votre signature', 'info');
            }
        }

        // Quick actions
        function showQuickActions() {
            document.getElementById('quick-actions-modal').classList.remove('hidden');
        }

        function closeQuickActions() {
            document.getElementById('quick-actions-modal').classList.add('hidden');
        }

        function refreshMessages() {
            if (isLoading) return;
            showToast('Actualisation des messages...', 'info');
            loadMessages();
        }

        function showArchiveManager() {
            showToast('Gestionnaire d\'archives en d√©veloppement', 'info');
        }

        // Statistics update
        function updateStats() {
            const nonArchivedMessages = allMessages.filter(m => 
                !m.archived && m.status.toLowerCase() !== 'archived'
            );
            const stats = {
                total: nonArchivedMessages.length, // Exclure les archiv√©s du total
                auto: allMessages.filter(m => m.status.toLowerCase() === 'auto-sent').length,
                review: allMessages.filter(m => 
                    m.status.toLowerCase() === 'manual-review' || m.status.toLowerCase() === 'pending'
                ).length,
                urgent: allMessages.filter(m => 
                    m.priority === 'high' && !m.archived && m.status.toLowerCase() !== 'archived'
                ).length,
                pending: allMessages.filter(m => m.status.toLowerCase() === 'pending').length,
                archived: allMessages.filter(m => m.archived || m.status.toLowerCase() === 'archived').length
            };

            // Update header stats
            document.getElementById('total-count').textContent = `${stats.total} messages`;
            document.getElementById('auto-count').textContent = stats.auto;
            document.getElementById('review-count').textContent = stats.review;
            document.getElementById('urgent-count').textContent = stats.urgent;
            document.getElementById('pending-count').textContent = stats.pending;
            document.getElementById('archived-count').textContent = stats.archived;

            // Update tab badges
            document.getElementById('dashboard-badge').textContent = stats.urgent;
            document.getElementById('auto-badge').textContent = stats.auto;
            document.getElementById('validation-badge').textContent = stats.review;
            document.getElementById('archive-badge').textContent = stats.archived;

            // Update specific stats
            document.getElementById('today-auto').textContent = stats.auto;
            
            // Calculer la pr√©cision IA bas√©e sur les messages avec confiance > 85%
            const highConfidenceMessages = allMessages.filter(m => m.confidence >= 85);
            const accuracy = allMessages.length > 0 ? 
                Math.round((highConfidenceMessages.length / allMessages.length) * 100) : 0;
            document.getElementById('ai-accuracy').textContent = `${accuracy}%`;
        }

        // Loading states
        function showLoadingInContainers() {
            const loadingHTML = `
                <div class="text-center py-8 text-gray-500">
                    <div class="loading-spinner mx-auto mb-4"></div>
                    <p class="text-sm">Chargement...</p>
                </div>
            `;
            
            const containers = [
                'urgent-messages',
                'surveillance-auto-send', 
                'auto-send-messages',
                'validation-messages',
                'archived-messages',
                'all-messages'
            ];
            
            containers.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.innerHTML = loadingHTML;
                }
            });
        }

        function showErrorInContainers(error) {
            const errorHTML = `
                <div class="text-center py-8 text-red-500">
                    <i data-lucide="alert-circle" class="w-12 h-12 mx-auto mb-4"></i>
                    <p class="text-sm">Erreur: ${error}</p>
                    <button onclick="refreshMessages()" class="mt-2 px-4 py-2 bg-red-100 text-red-700 rounded-lg text-sm hover:bg-red-200">
                        R√©essayer
                    </button>
                </div>
            `;
            
            const containers = [
                'urgent-messages',
                'surveillance-auto-send', 
                'auto-send-messages',
                'validation-messages',
                'archived-messages',
                'all-messages'
            ];
            
            containers.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.innerHTML = errorHTML;
                }
            });
            lucide.createIcons();
        }

        // Toast notifications
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            const icon = type === 'success' ? 'check' : type === 'error' ? 'alert-circle' : 'info';
            
            toast.className = `${bgColor} text-white px-4 py-3 rounded-lg shadow-lg fade-in flex items-center space-x-2`;
            toast.innerHTML = `
                <i data-lucide="${icon}" class="w-4 h-4"></i>
                <span class="text-sm">${message}</span>
            `;
            
            document.getElementById('toast-container').appendChild(toast);
            lucide.createIcons();
            
            setTimeout(() => {
                toast.remove();
            }, 4000);
        }

        // Event listeners
        document.getElementById('login-form').addEventListener('submit', handleLogin);

        // Filtres et recherche pour l'onglet "Tous"
        function setupFilters() {
            const statusFilter = document.getElementById('status-filter');
            const categoryFilter = document.getElementById('category-filter');
            const searchInput = document.getElementById('search-input');
            
            if (statusFilter) {
                statusFilter.addEventListener('change', () => {
                    if (currentTab === 'all') renderCurrentTab();
                });
            }
            
            if (categoryFilter) {
                categoryFilter.addEventListener('change', () => {
                    if (currentTab === 'all') renderCurrentTab();
                });
            }
            
            if (searchInput) {
                searchInput.addEventListener('input', () => {
                    if (currentTab === 'all') renderCurrentTab();
                });
            }
        }

        // Initialize app
        function init() {
            if (!currentUser) return;
            
            updateStats();
            renderCurrentTab();
            lucide.createIcons();
            
            // Configurer les filtres pour l'onglet "Tous"
            setupFilters();
            
            // Charger les messages au d√©marrage
            loadMessages();
            
            // Rafra√Æchir automatiquement toutes les 2 minutes
            setInterval(() => {
                if (!isLoading) {
                    loadMessages();
                }
            }, 120000);
        }

        // Start app
        document.addEventListener('DOMContentLoaded', () => {
            initAuth();
            lucide.createIcons();
        });

        // Handle back button for modals
        window.addEventListener('popstate', (event) => {
            if (!document.getElementById('message-modal').classList.contains('hidden')) {
                closeMessageModal();
            }
            if (!document.getElementById('quick-actions-modal').classList.contains('hidden')) {
                closeQuickActions();
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (!document.getElementById('message-modal').classList.contains('hidden')) {
                    closeMessageModal();
                }
                if (!document.getElementById('quick-actions-modal').classList.contains('hidden')) {
                    closeQuickActions();
                }
            }
            
            if (e.ctrlKey && !e.shiftKey && !e.altKey) {
                switch(e.key) {
                    case '1':
                        e.preventDefault();
                        switchTab('dashboard');
                        break;
                    case '2':
                        e.preventDefault();
                        switchTab('auto-send');
                        break;
                    case '3':
                        e.preventDefault();
                        switchTab('validation');
                        break;
                    case '4':
                        e.preventDefault();
                        switchTab('archives');
                        break;
                    case '5':
                        e.preventDefault();
                        switchTab('all');
                        break;
                    case 'r':
                        e.preventDefault();
                        refreshMessages();
                        break;
                }
            }
        });

    </script>
</body>
</html>
